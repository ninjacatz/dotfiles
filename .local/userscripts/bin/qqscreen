#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"
. "$source_dir/../qqlib"

# NOTE: cannot have more than 4 monitors
# NOTE: initial order of desktops inside switch statement indicates placement of desktops 1-4

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	-internal|-external|-external-1080p|-internal-external|-parents
EOF
}

internal_monitor="$qqinternal_monitor"
internal_res="$qqinternal_res"
internal_rate="$qqinternal_rate"

external_monitor="$qqexternal_monitor"
external_res="$qqexternal_res"
external_rate="$qqexternal_rate"

parents_monitor="$qqparents_monitor"
parents_res="$qqparents_res"

old_monitors=("$(xrandr | awk '/ connected/ && /[[:digit:]]x[[:digit:]].*+/{print $1}')")

case "$1" in
	-internal)
		new_monitors=("$internal_monitor")
		xrandr \
		--output "${new_monitors[0]}" --primary --mode $internal_res --rate $internal_rate
		"$source_dir/qqvolume" output default
		;;
	-external)
		new_monitors=("$external_monitor")
		xrandr \
		--output "${new_monitors[0]}" --primary --mode $external_res --rate $external_rate
		"$source_dir/qqvolume" output external
		;;
	-internal-external)
		new_monitors=("$internal_monitor" "$external_monitor")
		xrandr \
		--output "${new_monitors[0]}" --primary --mode $internal_res --rate $internal_monitor_rate \
		--output "${new_monitors[1]}" --mode $external_res --rate $external_monitor_rate --above "${new_monitors[0]}"
		"$source_dir/qqvolume" output external
		;;
	-parents)
		new_monitors=("$parents_monitor")
		xrandr \
		--output "${new_monitors[0]}" --primary --mode $parents_res --pos 0x0 --rotate normal
		"$source_dir/qqvolume" output external
		;;
	*)
		usage
		exit 1
		;;
esac

# sort and find removed monitors
mapfile -t old_monitors_sorted < <(printf "%s\n" "${old_monitors[@]}" | sort)
mapfile -t new_monitors_sorted < <(printf "%s\n" "${new_monitors[@]}" | sort)
mapfile -t monitors_removed < <(comm -23 \
	<(printf "%s\n" "${old_monitors_sorted[@]}") \
	<(printf "%s\n" "${new_monitors_sorted[@]}"))

# add temp_desktop to any monitors being removed
# the last desktop on a monitor cannot be removed, so an extra is needed
count=0
for removed_monitor in "${monitors_removed[@]}"; do
	bspc monitor "$removed_monitor" -a "temp_desktop$count"
	((count+=1))
done

# move desktops 1-4 based on new_monitors count
if (( ${#new_monitors[@]} == 1 )); then
	bspc desktop 1 --to-monitor "${new_monitors[0]}" || true
	bspc desktop 2 --to-monitor "${new_monitors[0]}" || true
	bspc desktop 3 --to-monitor "${new_monitors[0]}" || true
	bspc desktop 4 --to-monitor "${new_monitors[0]}" || true
elif (( ${#new_monitors[@]} == 2 )); then
	bspc desktop 1 --to-monitor "${new_monitors[0]}" || true
	bspc desktop 2 --to-monitor "${new_monitors[0]}" || true
	bspc desktop 3 --to-monitor "${new_monitors[1]}" || true
	bspc desktop 4 --to-monitor "${new_monitors[1]}" || true
elif (( ${#new_monitors[@]} == 3 )); then
	bspc desktop 1 --to-monitor "${new_monitors[0]}" || true
	bspc desktop 2 --to-monitor "${new_monitors[0]}" || true
	bspc desktop 3 --to-monitor "${new_monitors[1]}" || true
	bspc desktop 4 --to-monitor "${new_monitors[2]}" || true
elif (( ${#new_monitors[@]} == 4 )); then
	bspc desktop 1 --to-monitor "${new_monitors[0]}" || true
	bspc desktop 2 --to-monitor "${new_monitors[1]}" || true
	bspc desktop 3 --to-monitor "${new_monitors[2]}" || true
	bspc desktop 4 --to-monitor "${new_monitors[3]}" || true
fi

# remove automatically created desktops when new monitor is added
if bspc query -D -d "Desktop" 2> /dev/null; then
	bspc desktop Desktop -r
fi

# remove monitors with bspc and xrandr
# any temp_desktop created in removed monitors are automatically deleted
for removed_monitor in "${monitors_removed[@]}"; do
	bspc monitor "$removed_monitor" -r
	xrandr --output "$removed_monitor" --off
done

bspc wm -r

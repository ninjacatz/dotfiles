#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

# TODO: on t420, network blue key toggles wifi external to this script, may have to press twice

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	-wifi|-ethernet|-stop|-cli|-trash-networks
	-ssh|-vpn|-mac
		-start|-stop
EOF
}

network_path="/var/lib/iwd"

ethernet () {
	case "$1" in
		start)
			sudo "$source_dir/../qqsudo" service networking start
			;;
		stop)
			sudo "$source_dir/../qqsudo" service networking stop
			;;
	esac
}

wifi () {
	case "$1" in
		start)
			sudo "$source_dir/../qqsudo" service iwd start
			;;
		stop)
			sudo "$source_dir/../qqsudo" service iwd stop
			;;
	esac
}

ssh () {
	case "$1" in
		start)
			if ! pgrep -x sshd > /dev/null; then
				sudo "$source_dir/../qqsudo" service ssh start
			else
				echo "ssh already running"
			fi
			;;
		stop)
			if pgrep -x sshd > /dev/null; then
				sudo "$source_dir/../qqsudo" service ssh stop
				pkill -x ssh-agent
			else
				echo "ssh not running"
			fi
			;;
	esac
}

vpn () {
	case "$1" in
		start)
			if ! pgrep -x openvpn > /dev/null; then
				sudo "$source_dir/../qqsudo" service openvpn start
			else
				echo "vpn already running"
			fi
			;;
		stop)
			if pgrep -x openvpn > /dev/null; then
				sudo "$source_dir/../qqsudo" service openvpn stop
			else
				echo "vpn not running"
			fi
			;;
	esac
}

mac () {
	case "$1" in
		start)
			echo "Wifi mac randomization turned on"
			sudo "$source_dir/../qqsudo" sed -i '/AddressRandom/s/^#//' "/etc/iwd/main.conf"
			sudo "$source_dir/../qqsudo" macchanger -a eth0 || true
			touch /tmp/mac_on
			;;
		stop)
			echo "Wifi mac randomization turned off"
			sudo "$source_dir/../qqsudo" sed -i '/AddressRandom/ s/^#\?/#/' "/etc/iwd/main.conf"
			sudo "$source_dir/../qqsudo" macchanger -p eth0 || true
			rm -f /tmp/mac_on
			;;
	esac
}

case "$1" in
	-wifi)
		if pgrep -x iwd > /dev/null; then
			echo "wifi already running"
			exit 0
		fi
		vpn stop
		ssh stop
		ethernet stop
		wifi start
		# polybar boot disables wlan module if service not running
		polybar-msg cmd restart > /dev/null
		;;
	-ethernet)
		if pgrep -x dhclient > /dev/null; then
			echo "ethernet already running"
			exit 0
		fi
		vpn stop
		ssh stop
		wifi stop
		ethernet start
		;;
	-stop)
		vpn stop
		ssh stop
		wifi stop
		ethernet stop
		mac stop
		;;
	-ssh)
		case "$2" in
			-start)
				if pgrep -x dhclient > /dev/null || pgrep -x iwd > /dev/null; then
					ssh start
				else
					echo "No network services running. Start a network service before enabling ssh"
					exit 0
				fi
				;;
			-stop)
				ssh stop
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	-vpn)
		case "$2" in
			-start)
				if pgrep -x dhclient > /dev/null || pgrep -x iwd > /dev/null; then
					vpn start
				else
					echo "No network services running. Start a network service before starting vpn"
					exit 0
				fi
				;;
			-stop)
				vpn stop
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	-mac)
		if ! pgrep -x dhclient > /dev/null && ! pgrep -x iwd > /dev/null; then
			case "$2" in
				-start)
					mac start
					;;
				-stop)
					mac stop
					;;
				*)
					usage
					exit 1
					;;
			esac
		else
			echo "A network service is running. Stop any network services before configuring mac addresses"
			exit 0
		fi
		;;
	-cli)
		if pgrep -x iwd > /dev/null; then
			iwctl station wlan0 get-networks
			read -r -p "Enter network name: " network
			iwctl station wlan0 connect "$network"
		else
			echo "Wifi service not running. Start wifi first"
			exit 0
		fi
		;;
	-trash-networks)
		read -r -p "Are you sure you want to trash networks? (y/N) " answer
		if [ "${answer,,}" = "y" ]; then
			sudo "$source_dir/../qqsudo" trash "$network_path"/*
			echo "Trashed networks devices"
		else
			echo "Did not trash networks devices"
		fi
		;;
	*)
		usage
		exit 1
		;;
esac

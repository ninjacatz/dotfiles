#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	(w)ifi|(e)thernet|(ss)h|(v)pn|(m)ac
		on|off
	(s)top|(c)li-wifi|(t)rash-networks
EOF
}

network_path="/var/lib/iwd"

ethernet () {
	case "$1" in
		on)
			if pgrep -x dhclient > /dev/null; then
				echo "ethernet already running"
			else
				sudo "$source_dir/../qqsudo" service networking start
			fi
			;;
		off)
			if ! pgrep -x dhclient > /dev/null; then
				echo "ethernet not running"
			else
				ssh_interface=$(ip route get 192.168.1.100 | awk '{print $3}' || true)
				if [[ "$ssh_interface" == "eth0" ]]; then
					"$source_dir/qqnfs" 1 unmount || pkill sshfs
					"$source_dir/qqnfs" 2 unmount || pkill sshfs
				fi
				sudo "$source_dir/../qqsudo" service networking stop
				sudo "$source_dir/../qqsudo" pkill -x dhclient
			fi
			;;
	esac
}

wifi () {
	case "$1" in
		on)
			if pgrep -x iwd > /dev/null; then
				echo "wifi already running"
			else
				sudo "$source_dir/../qqsudo" service iwd start
			fi
			# polybar boot disables wlan module if service not running
			polybar-msg cmd restart > /dev/null
			;;
		off)
			if ! pgrep -x iwd > /dev/null; then
				echo "wifi not running"
			else
				ssh_interface=$(ip route get 192.168.1.100 | awk '{print $3}' || true)
				if [[ "$ssh_interface" == "wlan0" ]]; then
					"$source_dir/qqnfs" 1 unmount || pkill sshfs
					"$source_dir/qqnfs" 2 unmount || pkill sshfs
				fi
				sudo "$source_dir/../qqsudo" service iwd stop
			fi
			;;
	esac
}

ssh () {
	case "$1" in
		on)
			if ! pgrep -x dhclient > /dev/null && ! pgrep -x iwd > /dev/null; then
				echo "No network services running. Start a network service before enabling ssh"
			elif pgrep -x sshd > /dev/null; then
				echo "ssh already running"
			else
				sudo "$source_dir/../qqsudo" service ssh start
				sudo "$source_dir/../qqsudo" ufw allow ssh
			fi
			;;
		off)
			if ! pgrep -x sshd > /dev/null; then
				echo "ssh not running"
			else
				sudo "$source_dir/../qqsudo" service ssh stop
				sudo "$source_dir/../qqsudo" ufw delete allow ssh
				pkill -x ssh-agent
			fi
			;;
	esac
}

vpn () {
	case "$1" in
		on)
			if ! pgrep -x dhclient > /dev/null && ! pgrep -x iwd > /dev/null; then
				echo "No network services running. Start a network service before starting vpn"
			elif pgrep -x openvpn > /dev/null; then
				echo "vpn already running"
			else
				sudo "$source_dir/../qqsudo" service openvpn start
			fi
			;;
		off)
			if ! pgrep -x openvpn > /dev/null; then
				echo "vpn not running"
			else
				sudo "$source_dir/../qqsudo" service openvpn stop
			fi
			;;
	esac
}

mac () {
	case "$1" in
		on)
			if pgrep -x dhclient > /dev/null || pgrep -x iwd > /dev/null; then
				echo "A network service is running. Stop any network services before configuring mac addresses"
			else
				sudo "$source_dir/../qqsudo" sed -i '/AddressRandom/s/^#//' "/etc/iwd/main.conf"
				echo "Wifi mac randomization turned on"
				sudo "$source_dir/../qqsudo" macchanger -a eth0 || true
				touch /tmp/mac_on
			fi
			;;
		off)
			if pgrep -x dhclient > /dev/null || pgrep -x iwd > /dev/null; then
				echo "A network service is running. Stop any network services before configuring mac addresses"
			else
				sudo "$source_dir/../qqsudo" sed -i '/AddressRandom/ s/^#\?/#/' "/etc/iwd/main.conf"
				echo "Wifi mac randomization turned off"
				sudo "$source_dir/../qqsudo" macchanger -p eth0 || true
				rm -f /tmp/mac_on
			fi
			;;
	esac
}

case "$1" in
	wifi|w)
		case "$2" in
			on)
				wifi on
				;;
			off)
				wifi off
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	eth|e)
		case "$2" in
			on)
				ethernet on
				;;
			off)
				ethernet off
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	stop|s)
		vpn off
		ssh off
		wifi off
		ethernet off
		mac off
		;;
	ssh|ss)
		case "$2" in
			on)
				ssh on
				;;
			off)
				ssh off
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	vpn|v)
		case "$2" in
			on)
				vpn on
				;;
			off)
				vpn off
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	mac|m)
		case "$2" in
			on)
				mac on
				;;
			off)
				mac off
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	cli-wifi|c)
		if pgrep -x iwd > /dev/null; then
			iwctl station wlan0 get-networks
			read -r -p "Enter network name: " network
			iwctl station wlan0 connect "$network"
		else
			echo "Wifi service not running. Start wifi first"
		fi
		;;
	trash-networks|t)
		read -r -p "Are you sure you want to trash networks? (y/N) " answer
		if [ "${answer,,}" = "y" ]; then
			sudo "$source_dir/../qqsudo" trash "$network_path"/*
			echo "Trashed networks devices"
		else
			echo "Did not trash networks devices"
		fi
		;;
	*)
		usage
		exit 1
		;;
esac

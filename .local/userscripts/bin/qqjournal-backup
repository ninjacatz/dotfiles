#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

journal_path="/mnt/nfs/journal-unencoded"
journal_converted_path="$HOME/Downloads/journal-converted"
journal_ext1_path="/mnt/ext1/journal"

if [ ! -d "$journal_converted_path" ]; then
	echo "Converted journals not found"
	exit 1
fi

read -r -p "Would you like to trash old journals? (y/N) " trash_answer
read -r -p "Do you want to eject devices when done? (y/N) " eject_answer

"$source_dir/qqmount" ext1
"$source_dir/qqnfs" -mount home-server

# append the contents of the converted journals to the journals in ext1
rsync -av --ignore-existing "$journal_converted_path/" "$journal_ext1_path/"

if [ "${trash_answer,,}" = "y" ]; then
	trash "$journal_path"/*
	trash "$journal_converted_path"
	echo "Old journals trashed"
fi

if [ "${eject_answer,,}" = "y" ]; then
	"$source_dir/qqmount" -u ext1
	"$source_dir/qqnfs" -umount home-server
fi

echo "Done backing up"

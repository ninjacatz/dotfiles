#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	play-pause|stop|rewind|forward|seek-rewind|seek-forward
EOF
}

case $1 in
	play-pause)
		command="cycle pause"
		;;
	stop)
		command="stop"
		;;
	rewind)
		command="playlist-prev"
		;;
	forward)
		command="playlist-next"
		;;
	seek-rewind)
		command="seek -1"
		;;
	seek-forward)
		command="seek 1"
		;;
	*)
		usage
		exit 1
		;;
esac

# if currently focused window is mpv, perform function on only currently focused window
focused_window_class="$(xprop -id "$(bspc query -N -n focused)" | awk '/WM_CLASS/ {print $4}')"
if [ "$focused_window_class" = '"mpv"' ]; then
	mpv_pid="$(xprop -id "$(bspc query -N -n focused)" | awk '/_NET_WM_PID/ {print $3}')"
# otherwise, perform function on only the first opened mpv window (smallest pid)
else
	smallest_pid=999999
	if find /tmp/mpvSockets -mindepth 1 | read -r; then
		for pid in /tmp/mpvSockets/*; do
			pid=$(basename "$pid")
			if [[ "$smallest_pid" -gt "$pid" ]]; then
				smallest_pid=$pid
			fi
		done
		mpv_pid=$smallest_pid
	else
		echo "No MPV instance running"
		exit 1
	fi
fi

echo $command | socat - "/tmp/mpvSockets/$mpv_pid"

#!/bin/bash
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"
. "$source_dir/../qqlib"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	up|down|min|max
	mute
		on|off|toggle
	input
		on|off|toggle
	output
		default|external
EOF
}

default_master="$qqdefault_master"
default_card="$qqdefault_card"
default_hw="$qqdefault_hw"

ext_master="$qqext_master"
ext_card="$qqext_card"
ext_hw="$qqext_hw"

increment=5

current_dev=$(grep hw: "$HOME/.asoundrc" | awk -F'"' '{print $2}')
if [ "$current_dev" == "$default_hw" ]; then
	current_master="$default_master"
elif [ "$current_dev" == "$ext_hw" ]; then
	current_master="$ext_master"
else
	echo "Not a known device"
	exit 1
fi

case "$1" in
	up)
		amixer set "$current_master" "$increment%+"
		;;
	down)
		amixer set "$current_master" "$increment%-"
		;;
	min)
		amixer set "$current_master" 0%
		;;
	max)
		amixer set "$current_master" 100%
		;;
	mute)
		case "$2" in
			on)
				amixer set "$current_master" mute
				;;
			off)
				amixer set "$current_master" unmute
				;;
			toggle)
				if amixer get "$current_master" | grep -q '\[off\]'; then
					amixer set "$current_master" unmute
				else
					amixer set "$current_master" mute
				fi
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	input)
		case "$2" in
			on)
				amixer set Capture cap
				sudo "$source_dir/../qqsudo" chmod 660 /dev/video0
				;;
			off)
				amixer set Capture nocap
				sudo "$source_dir/../qqsudo" chmod 000 /dev/video0
				;;
			toggle)
				if amixer get Capture | grep "\[on\]" > /dev/null; then
					amixer set Capture nocap
					sudo "$source_dir/../qqsudo" chmod 000 /dev/video0
				else
					amixer set Capture cap
					sudo "$source_dir/../qqsudo" chmod 660 /dev/video0
				fi
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	output)
		case "$2" in
			default)
				sed -i "s/^[[:space:]]*pcm .*/\t\tpcm \"$default_hw\"/" "$HOME/.asoundrc"
				sed -i "s/card .*/card $default_card/g" "$HOME/.asoundrc"
				sed -i "s/master-mixer = .*/master-mixer = $default_master/" "$HOME/.config/polybar/config.ini"
				polybar-msg cmd restart > /dev/null
				;;
			external)
				sed -i "s/^[[:space:]]*pcm .*/\t\tpcm \"$ext_hw\"/" "$HOME/.asoundrc"
				sed -i "s/card .*/card $ext_card/g" "$HOME/.asoundrc"
				sed -i "s/master-mixer = .*/master-mixer = $ext_master/" "$HOME/.config/polybar/config.ini"
				polybar-msg cmd restart > /dev/null
				;;
			*)
				usage
				exit 1
				;;
		esac
		echo "Changed audio to $(grep '^[[:space:]]*pcm ' ~/.asoundrc | sed 's/^[[:space:]]*pcm //')"
		;;
	*)
		usage
		exit 1
		;;
esac

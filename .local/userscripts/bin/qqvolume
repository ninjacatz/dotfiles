#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"
. "$source_dir/../qqlib"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	up|down|min|max
	mute
		on|off|toggle
	in
		on|off|toggle
	out
		default|ext
EOF
}

default_master="$qqvolume_default_master"
default_card="$qqvolume_default_card"
default_hw="$qqvolume_default_hw"

ext_master="$qqvolume_ext_master"
ext_card="$qqvolume_ext_card"
ext_hw="$qqvolume_ext_hw"

increment=5

current_dev=$(grep hw: "$HOME/.asoundrc" | awk -F'"' '{print $2}')
if [ "$current_dev" == "$default_hw" ]; then
	current_master="$default_master"
	current_card="$default_card"
elif [ "$current_dev" == "$ext_hw" ]; then
	current_master="$ext_master"
	current_card="$ext_card"
else
	echo "Not a known device"
	exit 1
fi

case "$1" in
	up)
		amixer -c "$current_card" set "$current_master" "$increment%+"
		;;
	down)
		amixer -c "$current_card" set "$current_master" "$increment%-"
		;;
	min)
		amixer -c "$current_card" set "$current_master" 0%
		;;
	max)
		amixer -c "$current_card" set "$current_master" 100%
		;;
	mute)
		case "$2" in
			on)
				amixer -c "$current_card" set "$current_master" mute
				;;
			off)
				amixer -c "$current_card" set "$current_master" unmute
				;;
			toggle)
				if amixer -c "$current_card" get "$current_master" | grep -q '\[off\]'; then
					amixer -c "$current_card" set "$current_master" unmute
				else
					amixer -c "$current_card" set "$current_master" mute
				fi
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	in)
		case "$2" in
			on)
				amixer  -c "$default_card" set Capture cap
				sudo "$source_dir/../qqsudo" chmod 660 /dev/video* || true
				;;
			off)
				amixer  -c "$default_card" set Capture nocap
				sudo "$source_dir/../qqsudo" chmod 000 /dev/video* || true
				;;
			toggle)
				if amixer -c "$default_card" get Capture | grep "\[on\]" > /dev/null; then
					amixer -c "$default_card" set Capture nocap
					sudo "$source_dir/../qqsudo" chmod 000 /dev/video* || true
				else
					amixer -c "$default_card" set Capture cap
					sudo "$source_dir/../qqsudo" chmod 660 /dev/video* || true
				fi
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	out)
		case "$2" in
			default)
				sed -i "s/^[[:space:]]*pcm .*/\t\tpcm \"$default_hw\"/" "$HOME/.asoundrc"
				sed -i "s/card .*/card $default_card/g" "$HOME/.asoundrc"

				sed -i "s/master-mixer = .*/master-mixer = $default_master/" "$HOME/.config/polybar/config.ini"
				sed -i "s/master-soundcard .*/master-soundcard = hw:$default_card/g" "$HOME/.config/polybar/config.ini"
				sed -i "s/speaker-soundcard .*/speaker-soundcard = hw:$default_card/g" "$HOME/.config/polybar/config.ini"
				sed -i "s/headphone-soundcard .*/headphone-soundcard = hw:$default_card/g" "$HOME/.config/polybar/config.ini"

				polybar-msg cmd restart > /dev/null
				;;
			ext)
				sed -i "s/^[[:space:]]*pcm .*/\t\tpcm \"$ext_hw\"/" "$HOME/.asoundrc"
				sed -i "s/card .*/card $ext_card/g" "$HOME/.asoundrc"

				sed -i "s/master-mixer = .*/master-mixer = $ext_master/" "$HOME/.config/polybar/config.ini"
				sed -i "s/master-soundcard .*/master-soundcard = hw:$ext_card/g" "$HOME/.config/polybar/config.ini"
				sed -i "s/speaker-soundcard .*/speaker-soundcard = hw:$ext_card/g" "$HOME/.config/polybar/config.ini"
				sed -i "s/headphone-soundcard .*/headphone-soundcard = hw:$ext_card/g" "$HOME/.config/polybar/config.ini"

				polybar-msg cmd restart > /dev/null
				;;
			*)
				usage
				exit 1
				;;
		esac
		echo "Changed audio to $(grep '^[[:space:]]*pcm ' ~/.asoundrc | sed 's/^[[:space:]]*pcm //')"
		;;
	*)
		usage
		exit 1
		;;
esac

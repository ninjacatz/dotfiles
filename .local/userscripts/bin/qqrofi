#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	-app|-game
EOF
}

dpi=$(awk '/dpi:/ {print $2}' "$HOME/.Xresources")
font="jetbrains mono 13"
theme="$HOME/.config/rofi/themes/gruvbox-dark.rasi"
flags=(-disable-history -scroll-method 1 -font "$font" -dpi "$dpi" -theme "$theme" -theme-str 'listview {lines: 10;}')

case $1 in
	-app)
		# "-drun-exclude-categories" flag not working (bad version of rofi), which is why the following junk is necessary
		# make all desktop files with "Game" category have ONLY "Game" category
		sudo "$source_dir/../qqsudo" sed -i '/Categories.*Game/ s/^Categories=.*$/Categories=Game/' /usr/share/applications/*
		# collect all non-game categories, separated by commas
		non_game_categories=$(grep "Categories=" /usr/share/applications/*.desktop | awk -F '=' '{print $2}' | tr ';' '\n' | grep -v '^$' | sort | uniq | grep -v Game | awk '{printf "%s%s", sep, $0; sep=","} END {print ""}')

		modi=(-drun-categories "$non_game_categories" -drun-match-fields name -drun-display-format '{name}' -modi drun -show drun -display-drun "App")

		rofi "${flags[@]}" "${modi[@]}"
		;;
	-game)
		# find all .desktop files, extract name@exec_line, and sort them
		names_and_execs=()
		while IFS= read -r path; do
			name=$(awk -F= '/^Name=/ {print $2}' "$path")
			exec_line=$(awk -F= '/^Exec=/ {print $2}' "$path")
			names_and_execs+=("$name@$(dirname "$path")${exec_line:1}")
		done < <(find ~/Games -maxdepth 2 -name "*.desktop")
		mapfile -t names_and_execs < <(printf "%s\n" "${names_and_execs[@]}" | sort)

		# display names and select with rofi
		rofi_selection=$(\
		for name_and_exec in "${names_and_execs[@]}"; do
			echo "$name_and_exec" | cut -d'@' -f1
		done \
		| rofi "${flags[@]}" -dmenu -i -p "Game")

		# match selected name with name in list and run exec_line part
		for name_and_exec in "${names_and_execs[@]}"; do
			name=$(echo "$name_and_exec" | cut -d'@' -f1)
			if [[ "$name" == "$rofi_selection" ]]; then
				exec_line=$(echo "$name_and_exec" | cut -d'@' -f2)
				sh -c "$exec_line"
				break
			fi
		done
		;;
	*)
		usage
		exit 1
		;;
esac


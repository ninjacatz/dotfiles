#!/bin/bash
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

dpi=$(awk '/dpi:/ {print $2}' $HOME/.Xresources)
font="jetbrains mono 13"
flags="-dpi $dpi -disable-history -scroll-method 0 -no-fixed-num-lines"

case $1 in
	-app)
		modi="-drun-match-fields name -drun-display-format {name} -modi drun -show drun"

		# make all desktop files with "Game" category have ONLY "Game" category
		sudo $source_dir/../qqsudo sed -i '/Categories.*Game/ s/^Categories=.*$/Categories=Game/' /usr/share/applications/*

		non_game_categories=$(grep "Categories=" /usr/share/applications/*.desktop | awk -F '=' '{print $2}' | tr ';' '\n' | grep -v '^$' | sort | uniq | grep -v Game | awk '{printf "%s%s", sep, $0; sep=","} END {print ""}')

		rofi $flags -font "$font" \
		-theme-str 'listview { lines: 10; }' \
		-drun-categories $non_game_categories $modi
		;;
	-game)
		lines=10

		# find .desktop paths and names in order
		paths=$(find ~/Games -maxdepth 2 -name "*.desktop")
		names_and_paths=()
		for path in $paths; do
			name=$(grep -m1 '^Name=' "$path" | cut -d= -f2)
			names_and_paths+=("$name|||$path")
		done
		mapfile -t names_and_paths < <(printf "%s\n" "${names_and_paths[@]}" | sort)

		# display names and select with rofi
		rofi_selection=$(\
		for name_and_path in "${names_and_paths[@]}"; do
			echo "$name_and_path" | cut -d'|' -f1
		done \
		| rofi $flags -font "$font" \
		-theme-str "listview { lines: $lines; }" \
		-dmenu -i -p Game)

		# match selected name with name in list and run exec line from desktop file
		for name_and_path in "${names_and_paths[@]}"; do
			name=$(echo "$name_and_path" | cut -d'|' -f1)
			if [[ "$name" == "$rofi_selection" ]]; then
				path=$(echo "$name_and_path" | cut -d'|' -f4)
				exec_line=$(grep '^Exec' "$path" | cut -d'=' -f 2-)
				cd $(dirname $path)
				sh -c "$exec_line"
				break
			fi
		done
		;;
	*)
		echo "Invalid argument (-app, -game)"
		exit 1
		;;
esac


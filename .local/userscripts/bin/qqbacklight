#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"
. "$source_dir/../qqlib"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	-internal|-external
		-up|-down|-max|-min
EOF
}

internal_backlight_path="$qqinternal_backlight_path"
internal_increment="$qqinternal_increment"
keyboard_backlight_path="$qqkeyboard_backlight_path"
keyboard_increment="$qqkeyboard_increment"
external_backlight_address="$qqexternal_backlight_address"
external_backlight_device="$qqexternal_backlight_device"
external_increment="$qqexternal_increment"

# set up variables
case "$1" in
	-internal)
		min=0
		increment="$internal_increment"

		backlight=$(cat "$internal_backlight_path/brightness")
		max=$(cat "$internal_backlight_path/max_brightness")
		;;
	-keyboard)
		min=0
		increment="$keyboard_increment"

		backlight=$(cat "$keyboard_backlight_path/brightness")
		max=$(cat "$keyboard_backlight_path/max_brightness")
		;;
	-external)
		min=0
		increment="$external_increment"

		read -r backlight max <<< "$(ddccontrol -r "$external_backlight_address" dev:"$external_backlight_device" | awk -F '[/ ]' '/^Control/ {print $4, $5; exit}')"
		;;
	*)
		usage
		exit 1
		;;
esac

# find new value
case "$2" in
	-up)
		total=$((backlight + increment))
		((total > max)) && total=$max
		;;
	-down)
		total=$((backlight - increment))
		((total < min)) && total=$min
		;;
	-max)
		total=$max
		;;
	-min)
		total=$min
		;;
	*)
		usage
		exit 1
		;;
esac

# change brightness
case "$1" in
	-internal)
		echo "$total" | sudo "$source_dir/../qqsudo" tee "$internal_backlight_path/brightness"
		;;
	-keyboard)
		echo "$total" | sudo "$source_dir/../qqsudo" tee "$keyboard_backlight_path/brightness"
		;;
	-external)
		ddccontrol -r "$external_backlight_address" -w "$total" dev:"$external_backlight_device"
		;;
esac

# kill ddccontrol daemon after period of inactivity
(
	sleep 20
	sudo "$source_dir/../qqsudo" pkill ddccontrol_serv || true
	sudo "$source_dir/../qqsudo" pkill ddcpci || true
) &

#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"
. "$source_dir/../qqlib"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	int|key|ext
		up|down|max|min
EOF
}

int_path="$qqbacklight_int_path"
int_increment="$qqbacklight_int_increment"
key_path="$qqbacklight_key_path"
key_increment="$qqbacklight_key_increment"
ext_address="$qqbacklight_ext_address"
ext_device="$qqbacklight_ext_device"
ext_increment="$qqbacklight_ext_increment"

# set up variables
case "$1" in
	int)
		min=0
		increment="$int_increment"

		backlight=$(cat "$int_path/brightness")
		max=$(cat "$int_path/max_brightness")
		;;
	key)
		min=0
		increment="$key_increment"

		backlight=$(cat "$key_path/brightness")
		max=$(cat "$key_path/max_brightness")
		;;
	ext)
		min=0
		increment="$ext_increment"

		read -r backlight max <<< "$(ddccontrol -r "$ext_address" dev:"$ext_device" | awk -F '[/ ]' '/^Control/ {print $4, $5; exit}')"
		;;
	*)
		usage
		exit 1
		;;
esac

# find new value
case "$2" in
	up)
		total=$((backlight + increment))
		((total > max)) && total=$max
		;;
	down)
		total=$((backlight - increment))
		((total < min)) && total=$min
		;;
	max)
		total=$max
		;;
	min)
		total=$min
		;;
	*)
		usage
		exit 1
		;;
esac

# change brightness
case "$1" in
	int)
		echo "$total" | sudo "$source_dir/../qqsudo" tee "$int_path/brightness"
		;;
	key)
		echo "$total" | sudo "$source_dir/../qqsudo" tee "$key_path/brightness"
		;;
	ext)
		ddccontrol -r "$ext_address" -w "$total" dev:"$ext_device"
		;;
esac

# kill ddccontrol daemon after period of inactivity
# (
	# sleep 10
	# sudo "$source_dir/../qqsudo" pkill ddccontrol_serv || true
	# sudo "$source_dir/../qqsudo" pkill ddcpci || true
# ) &

#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	-internal|-external
		-up|-down|-max|-min
EOF
}

# set up variables
case "$1" in
	-internal)
		backlight_path="/sys/class/backlight/acpi_video0"
		min=0
		increment=1

		backlight=$(cat "$backlight_path/brightness")
		max=$(cat "$backlight_path/max_brightness")
		;;
	-keyboard)
		keyboard_backlight_path="/sys/class/leds/tpacpi::thinklight"
		min=0
		increment=255

		backlight=$(cat "$keyboard_backlight_path/brightness")
		max=$(cat "$keyboard_backlight_path/max_brightness")
		;;
	-external)
		external_backlight_device="/dev/i2c-7"
		external_backlight_address="0x10"
		min=0
		increment=34

		read -r backlight max <<< "$(ddccontrol -r "$external_backlight_address" dev:"$external_backlight_device" | awk -F '[/ ]' '/^Control/ {print $4, $5; exit}')"
		;;
	*)
		usage
		exit 1
		;;
esac

# find new value
case "$2" in
	-up)
		total=$((backlight + increment))
		((total > max)) && total=$max
		;;
	-down)
		total=$((backlight - increment))
		((total < min)) && total=$min
		;;
	-max)
		total=$max
		;;
	-min)
		total=$min
		;;
	*)
		usage
		exit 1
		;;
esac

# change brightness
case "$1" in
	-internal)
		echo "$total" | sudo "$source_dir/../qqsudo" tee "$backlight_path/brightness"
		;;
	-keyboard)
		echo "$total" | sudo "$source_dir/../qqsudo" tee "$keyboard_backlight_path/brightness"
		;;
	-external)
		ddccontrol -r "$external_backlight_address" -w "$total" dev:"$external_backlight_device"
		# kill ddccontrol daemon after period of inactivity
		(
			sleep 20
			sudo "$source_dir/../qqsudo" pkill ddccontrol_serv || true
			sudo "$source_dir/../qqsudo" pkill ddcpci || true
		) &
		;;
esac

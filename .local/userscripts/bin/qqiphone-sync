#!/bin/bash
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

iphone_mnt_path="/mnt/iphone"
iphone_download_path="$HOME/Downloads/iphone"

sudo $source_dir/../qqsudo service usbmuxd restart

read -p "Press enter when iPhone is connected..."

# to mount iphone
sudo $source_dir/../qqsudo ifuse $iphone_mnt_path

if [ -z "$(sudo $source_dir/../qqsudo ls -A $iphone_mnt_path)" ]; then
	sudo $source_dir/../qqsudo pkill ifuse
	echo "iPhone not mounted"
	exit 1
fi

# copy the folder for pictures and videos
echo "Copying files..."
if [ ! -d $iphone_download_path ]; then
	mkdir $iphone_download_path
fi
sudo $source_dir/../qqsudo cp -r $iphone_mnt_path/DCIM $iphone_download_path

# change ownership to allow access
sudo $source_dir/../qqsudo chown -R $USER:$USER $iphone_download_path
sudo $source_dir/../qqsudo chmod -R 755 $iphone_download_path

# flatten all files
find $iphone_download_path -type f -exec mv {} $iphone_download_path \;

# remove DCIM folder
rm -rf $iphone_download_path/DCIM

echo "Files copied to $iphone_download_path"

# killing processes
sudo $source_dir/../qqsudo pkill ifuse

# converting all .heic files to .png
echo "Converting HEIC files..."
if [ "$(find $iphone_download_path -maxdepth 1 -type f -name '*.HEIC' -print -quit)" ]; then
	for file in $iphone_download_path/*.HEIC; do
		filename=$(basename "$file")
		filename="${filename%.*}"
		convert "$file" "$iphone_download_path/${filename}.png"
		rm "$file"
	done
fi

# remove executable
chmod -x "$iphone_download_path"/*

echo "Done syncing iPhone"

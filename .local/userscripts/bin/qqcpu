#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	-start-cons|-ac-perf
	-mode
		start|ac|bat
	-governor
		performance|conservative
EOF
}

case "$1" in
	-mode)
		case "$2" in
			start|ac|bat)
				sudo "$source_dir/../qqsudo" tlp "$2"
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	-governor)
		cpu_cores=$(nproc)
		cpu_cores=$((cpu_cores-1))

		case "$2" in
			performance|conservative)
				for i in $(seq 0 "$cpu_cores"); do
					sudo "$source_dir/../qqsudo" cpufreq-set -c "$i" -g "$2"
				done
				;;
			*)
				usage
				exit 1
				;;
		esac

		echo "Governors for cpu0-cpu$cpu_cores:"
		cpufreq-info | awk -F '\"' '/may decide/ {print $2}'
		;;
	-start-cons)
		"$source_dir/qqcpu" -mode start
		"$source_dir/qqcpu" -governor conservative
		;;
	-ac-perf)
		"$source_dir/qqcpu" -mode ac
		"$source_dir/qqcpu" -governor performance
		;;
	*)
		usage
		exit 1
		;;
esac

#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	default|performance
	mode
		start|ac|bat
	gov
		performance|conservative
EOF
}

case "$1" in
	mode)
		case "$2" in
			start|ac|bat)
				sudo "$source_dir/../qqsudo" tlp "$2"
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	gov)
		cpu_cores=$(nproc)
		cpu_cores=$((cpu_cores-1))

		case "$2" in
			performance|conservative)
				for i in $(seq 0 "$cpu_cores"); do
					sudo "$source_dir/../qqsudo" cpufreq-set -c "$i" -g "$2"
				done
				;;
			*)
				usage
				exit 1
				;;
		esac

		echo "Governors for cpu0-cpu$cpu_cores:"
		cpufreq-info | awk -F '\"' '/may decide/ {print $2}'
		;;
	default)
		"$source_dir/qqcpu" mode start
		"$source_dir/qqcpu" gov conservative
		;;
	performance)
		"$source_dir/qqcpu" mode ac
		"$source_dir/qqcpu" gov performance
		;;
	*)
		usage
		exit 1
		;;
esac

#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

# Goes back 30 days
# Requires journal files to be named with lowercase 3-letter month name followed by day number (at the end of the file name)
# Example: journal-file-may22.jpg
# Checks for "-may22."

journal_path="/mnt/nfs/journal-unencoded"
journal_attach_path="$HOME/Downloads"

"$source_dir/qqnfs" -mount home-server

for days_ago in $(seq 0 30); do
	day=$(date -d "$days_ago days ago" +"%1d")
	month=$(date -d "$days_ago days ago" +"%b" | tr '[:upper:]' '[:lower:]')
	month_num=$(date -d "$days_ago days ago" +"%1m")
	year=$(date -d "$days_ago days ago" +"%Y")
	# if files exist in downloads folder
	if ls "$journal_attach_path"/*-"$month$day".* 1> /dev/null 2>&1; then
		"$source_dir/qqjournal-new-day" "$days_ago"
		mv "$journal_attach_path"/*-"$month$day".* "$journal_path/$year-$month_num/$month$day"
	fi
done

"$source_dir/qqjournal-attach.py" "$journal_path"

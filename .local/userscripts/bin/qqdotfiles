#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

git_dotfiles_fn() {
	git --git-dir="$HOME"/.dotfiles/ --work-tree="$HOME" "$@"
}

git_dotfiles=(
	"$HOME/.asoundrc"
	"$HOME/.bashrc"
	"$HOME/.gtkrc-2.0"
	"$HOME/.vim"
	"$HOME/.config/alacritty"
	"$HOME/.config/bspwm"
	"$HOME/.config/gtk-2.0"
	"$HOME/.config/gtk-3.0"
	"$HOME/.config/mpv"
	"$HOME/.config/polybar"
	"$HOME/.config/sxhkd"
	"$HOME/.config/vifm"
	"$HOME/.config/zathura"
	"$HOME/.config/mimeapps.list"
	"$HOME/.local/userscripts"
)

git_exclude=(
	".vim/autoload"
	".vim/plugged"
	".vim/swap"
	".vim/viminfo"
	".vim/claude-api.key"
	".config/mpv/watch_later"
	".config/sxhkd/acpi-lid"
	".config/vifm/vifminfo*"
	".config/vifm/vifm-help.txt"
	".config/vifm/scripts"
)


if [[ "$1" == "commit" ]]; then
	# add excluded files to ~/.dotfiles/info/exclude
	for file in "${git_exclude[@]}"; do
		if ! grep -Fxq "$file" "$HOME/.dotfiles/info/exclude"; then
			echo "$file" >> "$HOME/.dotfiles/info/exclude"
		fi
	done
	# remove any excluded files (if they were added before defined in ~/.dotfiles/info/exclude)
	for file in "${git_exclude[@]}"; do
		if git_dotfiles_fn ls-files --error-unmatch "$HOME/$file" > /dev/null 2>&1; then
			git_dotfiles_fn rm -r --cached "$HOME/$file"
		fi
	done
	# add all dotfiles
	for file in "${git_dotfiles[@]}"; do
		git_dotfiles_fn add "$file"
	done
	# check if there are changes to commit and then commit them
	if ! git_dotfiles_fn diff --cached --quiet; then
		git_dotfiles_fn commit -m "Automated commit $(date '+%Y-%m-%d %H:%M:%S')"
	else
		echo "No changes to commit"
	fi
# otherwise, pass all arguments directly to git
else
	git_dotfiles_fn "${@:1}"
fi

#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

dotfiles_fn() {
	git --git-dir="$HOME"/.dotfiles/ --work-tree="$HOME" "$@"
}

dotfiles=(
	"$HOME/.gitignore"
	"$HOME/.asoundrc"
	"$HOME/.bashrc"
	"$HOME/README.md"
	"$HOME/.vim"
	"$HOME/.config/alacritty"
	"$HOME/.config/bspwm"
	"$HOME/.config/mpv"
	"$HOME/.config/polybar"
	"$HOME/.config/sxhkd"
	"$HOME/.config/vifm"
	"$HOME/.config/zathura"
	"$HOME/.config/mimeapps.list"
	"$HOME/.local/userscripts"
)

gitignore=(
	"$HOME/.vim/viminfo"
	"$HOME/.config/mpv/watch_later"
	"$HOME/.config/sxhkd/acpi-lid"
	"$HOME/.config/vifm/vifminfo*"
	"$HOME/.config/vifm/vifm-help.txt"
)

# if the command is 'commit', add all files and only commit if there are changes
if [[ "$1" == "commit" ]]; then
	for file in "${dotfiles[@]}"; do
		dotfiles_fn add "$file"
	done
	for file in "${gitignore[@]}"; do
		dotfiles_fn rm -r --cached "$file"
	done
	# check if there are changes to commit
	if ! dotfiles_fn diff --cached --quiet; then
		dotfiles_fn commit -m "Automated commit $(date '+%Y-%m-%d %H:%M:%S')"
	else
		echo "No changes to commit"
	fi
# otherwise, pass all arguments directly to git
else
	dotfiles_fn "$@"
fi

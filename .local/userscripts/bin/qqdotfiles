#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

dotfiles=(
	"$HOME/.asoundrc"
	"$HOME/.bashrc"
	"$HOME/README.md"
	"$HOME/.vim"
	"$HOME/.config/alacritty"
	"$HOME/.config/bspwm"
	"$HOME/.config/mpv"
	"$HOME/.config/polybar"
	"$HOME/.config/sxhkd"
	"$HOME/.config/vifm"
	"$HOME/.config/zathura"
	"$HOME/.config/mimeapps.list"
	"$HOME/.local/userscripts"
)

exclude=(
	".vim/viminfo"
	".config/mpv/watch_later"
	".config/sxhkd/acpi-lid"
	".config/vifm/vifminfo*"
	".config/vifm/vifm-help.txt"
)

dotfiles_fn() {
	git --git-dir="$HOME"/.dotfiles/ --work-tree="$HOME" "$@"
}

exclude_fn() {
	for file in "${exclude[@]}"; do
		if ! grep -Fxq "$file" "$HOME/.dotfiles/info/exclude"; then
			echo "$file" >> "$HOME/.dotfiles/info/exclude"
		fi
	done
}

# if the command is 'commit', add all files and only commit if there are changes
if [[ "$1" == "commit" ]]; then
	exclude_fn
	for file in "${dotfiles[@]}"; do
		dotfiles_fn add "$file"
	done
	for file in "${exclude[@]}"; do
		dotfiles_fn rm -r --cached "$file"
	done
	# check if there are changes to commit
	if ! dotfiles_fn diff --cached --quiet; then
		dotfiles_fn commit -m "Automated commit $(date '+%Y-%m-%d %H:%M:%S')"
	else
		echo "No changes to commit"
	fi
# otherwise, pass all arguments directly to git
else
	dotfiles_fn "$@"
fi

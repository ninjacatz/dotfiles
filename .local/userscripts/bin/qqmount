#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

get_disk_path() {
	while [ "$disk_path" == "" ]; do
		lsblk
		read -r -p "Partition of $1: " disk
		if [ -b /dev/"$disk" ]; then
			disk_path="/dev/$disk"
		fi
	done
}

get_umnt_path() {
	while [ "$dev" == "" ]; do
		lsblk
		read -r -p "Directory to unmount: " mount_dir
		if mountpoint /mnt/"$mount_dir" > /dev/null; then
			dev="$mount_dir"
			dev_mnt_path="/mnt/$mount_dir"
		fi
	done
}

get_mnt_path() {
	while [ "$dev" == "" ]; do
		echo "Mountable directories:"
		for mntpoint in /mnt/*; do
			echo -n "$(basename "$mntpoint") "
		done
		echo
		read -r -p "Directory to mount: " mount_dir
		if ! mountpoint /mnt/"$mount_dir" > /dev/null; then
			dev="$mount_dir"
			dev_mnt_path="/mnt/$mount_dir"
		fi
	done
}

if [ "$1" == "-u" ]; then
	umount=true
	shift
fi

dev="$1"
dev_mnt_path="/mnt/$1"

if [ -z "$1" ]; then
	if [ "$umount" == "true" ]; then
		get_umnt_path
	else
		get_mnt_path
	fi
else
	if ! [ -e "$dev_mnt_path" ]; then
		echo "$dev_mnt_path directory doesn't exist"
		exit 1
	fi
fi

if [ "$custom_disk_path" != "" ]; then
	disk_path="$custom_disk_path"
else
	disk_path=$(mount | awk -v mnt="/mnt/$dev " '$3 == mnt { print $1 }')
fi

if [ "$umount" != "true" ]; then
	if mountpoint "$dev_mnt_path" > /dev/null; then
		echo "$dev already mounted"
		exit 0
	fi
fi

if [ "$umount" == "true" ]; then
	if mountpoint "$dev_mnt_path" > /dev/null; then
		echo "unmounting $dev..."
		sudo "$source_dir/../qqsudo" umount "$dev_mnt_path"
		success=true
	else
		echo "$dev not mounted"
		exit 0
	fi
	luks_disk_path=$(sudo "$source_dir/../qqsudo" cryptsetup status "$dev" | grep device: | awk '{print $2}')
	if [ "$luks_disk_path" == "" ]; then
		get_disk_path "$dev"
		luks_disk_path="$disk_path"
	fi
	if sudo "$source_dir/../qqsudo" cryptsetup isLuks "$luks_disk_path" 2> /dev/null; then
		if sudo "$source_dir/../qqsudo" cryptsetup status "$dev" > /dev/null; then
			echo "locking $dev..."
			sudo "$source_dir/../qqsudo" cryptsetup luksClose /dev/mapper/"$dev"
			success=true
		else
			echo "$dev already locked"
			exit 0
		fi
	fi
	if [ "$success" == "true" ]; then
		echo "success"
	fi
else
	get_disk_path "$dev"
	if sudo "$source_dir/../qqsudo" cryptsetup isLuks "$disk_path" 2> /dev/null; then
		if ! sudo "$source_dir/../qqsudo" cryptsetup status "$dev" > /dev/null; then
			echo "unlocking $dev..."
			sudo "$source_dir/../qqsudo" cryptsetup luksOpen "$disk_path" "$dev"
			success=true
		else
			echo "$dev already unlocked"
		fi
		disk_path="/dev/mapper/$dev" # for changing mount behavior to use newly setup /dev/mapper
	fi
	if ! mountpoint "$dev_mnt_path" > /dev/null; then
		echo "mounting $dev..."
		sudo "$source_dir/../qqsudo" mount "$disk_path" "$dev_mnt_path"
		success=true
	else
		echo "$dev already mounted"
		exit 0
	fi
	if ! find "$dev_mnt_path" -maxdepth 1 -user "$USER" > /dev/null; then
		echo "mounted files are not owned by $USER"
		# sudo chown -R "$USER":"$USER" "$dev_mnt_path"
	fi
	if [ "$success" == "true" ]; then
		echo "success"
	fi
fi

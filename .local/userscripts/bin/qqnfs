#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"
. "$source_dir/../qqssh"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	1|2
		(m)ount
		(u)nmount
			_|lock|ask
EOF
}

hs_or_lhs="$qqssh_hs_or_lhs"
echo "ssh: $hs_or_lhs"

if [[ "$1" = "1" ]]; then
	nfs_disk="/dev/sdb4"
elif [[ "$1" = "2" ]]; then
	nfs_disk="/dev/sda"
else
	echo "Not a valid nfs index"
	exit 1
fi

case "$2" in
	mount|m)
		if mountpoint /mnt/nfs"$1" > /dev/null; then
			echo "nfs$1 already mounted via sshfs"
			exit 0
		fi

		ssh -t "$hs_or_lhs" "bash ~/mount_nfs.sh $1" 2>/dev/null
		if ! mountpoint /mnt/nfs"$1" > /dev/null; then
			echo "mounting nfs$1 via sshfs..."
			nohup sshfs "$hs_or_lhs":/srv/nfs"$1" /mnt/nfs"$1" >/dev/null 2>&1 &
			echo "success"
		fi
		;;
	unmount|u)
		if [[ "$3" = "lock" ]]; then
			nfs_answer="y"
		elif [[ "$3" = "ask" ]]; then
			read -r -p "Do you want to lock nfs$1? (y/N) " nfs_answer
		fi

		if mountpoint /mnt/nfs"$1" > /dev/null; then
			echo "unmounting nfs$1 via sshfs..."
			fusermount -u /mnt/nfs"$1"
			echo "success"
		else
			echo "nfs$1 not mounted via sshfs"
		fi

		if ! [ "${nfs_answer,,}" = "y" ]; then
			exit 0
		fi

		ssh -t "$hs_or_lhs" "bash ~/umount_nfs.sh $1" 2>/dev/null
		;;
	*)
		usage
		exit 1
esac

#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	-trackpad|-trackpoint|-mouse
		-start|-stop
EOF
	exit 1
}

# device names
trackpads=("SynPS/2 Synaptics TouchPad")
trackpoints=("TPPS/2 IBM TrackPoint")
mice=("Logitech M325" "Logitech G400s")

case "$1" in
	-trackpad|-trackpoint|-mouse)
		if [[ "$1" == "-trackpad" ]]; then
			devices=("${trackpads[@]}")
		elif [[ "$1" == "-trackpoint" ]]; then
			devices=("${trackpoints[@]}")
		elif [[ "$1" == "-mouse" ]]; then
			devices=("${mice[@]}")
		fi
		device_ids=()
		for device in "${devices[@]}"; do
			device_ids+=($(xinput list | grep "$device" | awk -F'=' '{print $2}' | awk '{print $1}'))
		done
		case "$2" in
			-start)
				virtual_pointer_id=$(xinput list | awk -F '=' '/Virtual core pointer/ {print $2}' | awk '{print $1}')
				for id in "${device_ids[@]}"; do
					xinput enable "$id"
					if [[ "$1" == "-trackpad" || "$1" == "-trackpoint" ]]; then
						sleep 0.1
						xinput reattach "$id" "$virtual_pointer_id"
					fi
				done
				echo "${1#-} enabled"
				;;
			-stop)
				for id in "${device_ids[@]}"; do
					xinput disable "$id"
					if [[ "$1" == "-trackpad" || "$1" == "-trackpoint" ]]; then
						xinput float "$id"
					fi
				done
				echo "${1#-} disabled"
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	*)
		usage
		exit 1
		;;
esac

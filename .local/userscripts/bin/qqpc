#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"
. "$source_dir/../qqlib"

# TODO: if you dont login after waking from suspend, the computer stays on

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	(m)enu|(log)out|(r)eboot|(sh)utdown|(l)ock|(s)uspend|(h)ibernate
		not-with-(a)udio
EOF
}

backlight_key_path="$qqpc_backlight_key_path"
xlock_font=-*-helvetica-*-r-*-*-48-*-*-*-*-*-*-*

if [[ "$2" == "not-with-audio" || "$2" == "a" ]]; then
	if [ "$(grep -r "RUNNING" /proc/asound | wc -l)" -ne 0 ]; then
		echo "Audio is playing. Exiting"
		exit 0
	fi
fi

case "$1" in
	menu|m)
		usage
		read -r -p "Select option: " selection
		"$source_dir/qqpc" "$selection"
		;;
	logout|log)
		if [ "$HOSTNAME" != "optiplex-9020" ]; then
			"$source_dir/qqnet" stop
			"$source_dir/qqcoffee" off
			rm -f /tmp/bspwm_first_run
		fi
		pkill -KILL -u "$USER"
		;;
	reboot|r)
		sudo "$source_dir/../qqsudo" reboot
		;;
	shutdown|sh)
		sudo "$source_dir/../qqsudo" shutdown -h now
		;;
	lock|l)
		if [ "$HOSTNAME" != "optiplex-9020" ]; then
			"$source_dir/qqcoffee" off
			"$source_dir/qqvolume" mute on
			"$source_dir/qqvolume" in off || true
			backlight_key_value=$(cat "$backlight_key_path/brightness")
			"$source_dir/qqbacklight" key min
			xlock -info " " -username " " -password " Password: " -validate "Validating password..." -invalid "Invalid password" -bg Black -fg White +usefirst +description +showdate -echokeys -echokey "*" -font "$xlock_font" -startCmd "xset dpms force off" -dpmsoff 10 -timeout 10 \
			&& echo "$backlight_key_value" | sudo "$source_dir/../qqsudo" tee "$backlight_key_path/brightness" > /dev/null &
		fi
		;;
	suspend|s)
		if [ "$HOSTNAME" != "optiplex-9020" ]; then
			"$source_dir/qqpc" lock
			"$source_dir/qqnet" stop
			if [ "$HOSTNAME" = "m15" ]; then
				"$source_dir/qqdevice" keyboard off
				sudo "$source_dir/../qqsudo" rmmod facetimehd || true
			fi
		fi

		sudo "$source_dir/../qqsudo" pm-suspend

		if [ "$HOSTNAME" != "optiplex-9020" ]; then
			if [ "$HOSTNAME" = "m15" ]; then
				"$source_dir/qqdevice" keyboard on
				sudo "$source_dir/../qqsudo" modprobe facetimehd || true
			fi
			xset dpms force on
			xdotool key BackSpace
		fi
		;;
	hibernate|h)
		if [ "$HOSTNAME" != "optiplex-9020" ]; then
			"$source_dir/qqpc" lock
			"$source_dir/qqnet" stop
			if [ "$HOSTNAME" = "m15" ]; then
				sudo "$source_dir/../qqsudo" rmmod facetimehd || true
				sudo "$source_dir/../qqsudo" rmmod brcmfmac || true
			fi
		fi

		sudo "$source_dir/../qqsudo" pm-hibernate &

		# none of this runs
		# if [ "$HOSTNAME" != "optiplex-9020" ]; then
			# if [ "$HOSTNAME" = "m15" ]; then
				# sudo "$source_dir/../qqsudo" modprobe facetimehd || true
				# sudo "$source_dir/../qqsudo" modprobe brcmfmac || true
			# fi
			# xset dpms force on
			# xdotool key BackSpace
		# fi
		;;
	*)
		usage
		exit 1
		;;
esac

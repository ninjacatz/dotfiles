#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

# TODO: if you dont login after waking from suspend, the computer stays on

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	(m)enu|(log)out|(r)eboot|(sh)utdown|(l)ock|(s)uspend|(h)ibernate
		not-with-audio
EOF
}

xlock_font=-*-helvetica-*-r-*-*-48-*-*-*-*-*-*-*

if [ "$2" == "not-with-audio" ]; then
	if [ "$(grep -r "RUNNING" /proc/asound | wc -l)" -ne 0 ]; then
		echo "Audio is playing. Exiting"
		exit 0
	fi
fi

case "$1" in
	menu|m)
		usage
		read -r -p "Select option: " selection
		"$source_dir/qqpc" "$selection"
		;;
	logout|log)
		"$source_dir/qqnet" stop || true
		"$source_dir/qqcoffee" off || true
		rm -f /tmp/bspwm_first_run
		pkill -KILL -u "$USER"
		;;
	reboot|r)
		sudo "$source_dir/../qqsudo" reboot
		;;
	shutdown|sh)
		sudo "$source_dir/../qqsudo" shutdown -h now
		;;
	lock|l)
		"$source_dir/qqcoffee" off || true
		"$source_dir/qqvolume" mute on || true
		"$source_dir/qqvolume" in off || true
		"$source_dir/qqbacklight" key min || true

		xlock -info " " -username " " -password " Password: " -validate "Validating password..." -invalid "Invalid password" -bg Black -fg White +usefirst +description +showdate -echokeys -echokey "*" -font "$xlock_font" -startCmd "xset dpms force off" -dpmsoff 10 -timeout 10 &
		;;
	suspend|s)
		"$source_dir/qqpc" lock || true

		"$source_dir/qqnfs" 1 unmount || true
		"$source_dir/qqnet" stop || true

		"$source_dir/qqdevice" keyboard off
		sudo "$source_dir/../qqsudo" rmmod facetimehd || true

		sudo "$source_dir/../qqsudo" pm-suspend

		"$source_dir/qqdevice" keyboard on
		sudo "$source_dir/../qqsudo" modprobe facetimehd || true

		# turn on screen and simulate Return key press to trigger xlock
		xset dpms force on
		xdotool key BackSpace
		;;
	hibernate|h)
		"$source_dir/qqpc" lock || true

		"$source_dir/qqnfs" 1 unmount || true
		"$source_dir/qqnet" stop || true

		sudo "$source_dir/../qqsudo" rmmod facetimehd || true

		sudo "$source_dir/../qqsudo" pm-hibernate

		sudo "$source_dir/../qqsudo" modprobe facetimehd || true

		# turn on screen and simulate Return key press to trigger xlock
		xset dpms force on
		xdotool key BackSpace
		;;
	*)
		usage
		exit 1
		;;
esac

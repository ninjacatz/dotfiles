#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	-bar
		-hide|-show|-toggle
	-fullscreen
	-tiled
	-floating
	-desktop-occupied
		-next|-prev
	-select
		west|east|north|south|next|prev
	-move
		west|east|north|south
	-size
		left|right|top|bottom
EOF
}

move_value=80

is_floating() {
	local node_json
	node_json=$(bspc query -T -n focused 2>/dev/null || true)
	[[ -z "$node_json" ]] && return 1  # no focused node
	echo "$node_json" | jq -e '.client.state == "floating"' >/dev/null 2>&1
}

case "$1" in
	-bar)
		case "$2" in
			-hide)
				polybar-msg cmd hide && bspc config bottom_padding 0
				;;
			-show)
				polybar-msg cmd show
				;;
			-toggle)
				polybar-msg cmd toggle && bspc config bottom_padding 0
				;;
			*)
				usage
				exit 1
		esac
		;;
	-fullscreen)
		bspc node -t fullscreen
		;;
	-tiled)
		bspc node -t tiled
		;;
	-floating)
		bspc node -t floating
		;;
	-desktop-occupied)
		case "$2" in
			-next|-prev)
				desktops=("$(bspc query -D -d .occupied --names)")
				current=$(bspc query -D -d focused --names)

				current_index=-1
				for i in "${!desktops[@]}"; do
					if [[ "${desktops[$i]}" == "$current" ]]; then
						current_index=$i
						break
					fi
				done

				if [[ "$2" == "-next" ]]; then
					if (( current_index == -1 )); then
						target_index=0
					else
						target_index=$(( (current_index + 1) % ${#desktops[@]} ))
					fi
				else
					if (( current_index == -1 )); then
						target_index=$(( ${#desktops[@]} - 1 ))
					else
						target_index=$(( (current_index - 1 + ${#desktops[@]}) % ${#desktops[@]} ))
					fi
				fi

				target_desktop=${desktops[$target_index]}
				bspc desktop -f "$target_desktop"
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	-select)
		case "$2" in
			west|east|north|south)
				bspc node -f "$2"
				;;
			next|prev)
				bspc node -f "$2".local.!hidden.window
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	-move)
		case "$2" in
			west|east)
				if ! is_floating; then
					bspc node -s "$2"
				else
					move_x=$([ "$2" == "west" ] && echo "-$move_value" || echo "$move_value")
					bspc node -v "$move_x" 0
				fi
				;;
			north|south)
				if ! is_floating; then
					bspc node -s "$2"
				else
					move_y=$([ "$2" == "north" ] && echo "-$move_value" || echo "$move_value")
					bspc node -v 0 "$move_y"
				fi
				;;
			*)
				usage
				exit 1
				;;
			esac
		;;
	-size)
		case "$2" in
			left|right)
				move_x=$([ "$2" == "left" ] && echo "-$move_value" || echo "$move_value")
				if ! is_floating; then
					bspc node -z right "$move_x" 0 || bspc node -z left "$move_x" 0
				else
					bspc node -z right "$move_x" 0
					bspc node -z left "$([ "$2" == "left" ] && echo "$move_value" || echo "-$move_value")" 0
				fi
				;;
			top|bottom)
				move_y=$([ "$2" == "top" ] && echo "-$move_value" || echo "$move_value")
				if ! is_floating; then
					bspc node -z top 0 "$move_y" || bspc node -z bottom 0 "$move_y"
				else
					bspc node -z top 0 "$move_y"
					bspc node -z bottom 0 "$([ "$2" == "top" ] && echo "$move_value" || echo "-$move_value")"
				fi
				;;
			*)
				usage
				exit 1
				;;
		esac
		;;
	*)
		usage
		exit 1
		;;
esac

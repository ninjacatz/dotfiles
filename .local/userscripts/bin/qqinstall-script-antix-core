#!/bin/bash

if [ $(id -u) -eq 0 ]; then
	echo "Run as user"
	exit 1
fi

sudo echo ""
read -p "Must be connected to the internet. Press enter to continue"
read -p "WARNING: If running script for the second time (or more), make sure backups have been completed, or no important changes have been made. Press enter to continue"

# Save the error messages
errors_file="$HOME/qqinstall-output.txt"
touch "$errors_file"
echo -e "\n\n\nqqinstall: $(date +"%-I:%M%P %a %b %-d")" >> "$errors_file"
mkfifo /tmp/pipe
tee -a "$errors_file" < /tmp/pipe &
exec > /tmp/pipe 2>&1

# ##########################
# Functions
# ##########################

qq_apt_add () {
	for arg in "$@"; do
		if dpkg -l | grep -q "^ii  $arg "; then
			echo "qq_apt_add: $arg already installed"
		else
			echo "qq_apt_add: Installing $arg"
			sudo apt install "$arg" -y
		fi
	done
}

qq_apt_rm () {
	for arg in "$@"; do
		if dpkg -l | grep -q "^ii  $arg "; then
			echo "qq_apt_rm: Removing $arg"
			sudo apt purge "$arg" -y
		else
			echo "qq_apt_rm: $arg not installed"
		fi
	done
}

qq_conf_add() {
	for arg in "$@"; do
		arg_trim="/$(echo "$arg" | cut -d'/' -f5-)"
		if [ ! -e "$arg_trim" ]; then
			echo "qq_conf_add: Copying $arg_trim"
			cp -r "$arg" "$arg_trim"
		else
			echo "qq_conf_add: Already exists: $arg_trim"
		fi
	done
}

qq_conf_add_ow() {
	for arg in "$@"; do
		arg_trim="/$(echo "$arg" | cut -d'/' -f5-)"
		echo "qq_conf_add_ow: Copying $arg_trim"
		rm -rf "$arg_trim"
		cp -r "$arg" "$arg_trim"
	done
}

qq_su_conf_add() {
	for arg in "$@"; do
		arg_trim="/$(echo "$arg" | cut -d'/' -f5-)"
		if sudo [ ! -e "$arg_trim" ]; then
			echo "qq_su_conf_add: Copying $arg_trim"
			sudo cp -r "$arg" "$arg_trim"
		else
			echo "qq_su_conf_add: Already exists: $arg_trim"
		fi
	done
}

qq_su_conf_add_ow() {
	for arg in "$@"; do
		arg_trim="/$(echo "$arg" | cut -d'/' -f5-)"
		echo "qq_su_conf_add_ow: Copying $arg_trim"
		sudo rm -rf "$arg_trim"
		sudo cp -r "$arg" "$arg_trim"
	done
}

qq_root_ln() {
	trim=$(echo "$1" | sed "s|/home/$USER/||")
	link="/root/$trim"
	if sudo [ ! -L "$link" ]; then
		echo "qq_root_ln: Linking $1"
		sudo ln -s "$1" "$link"
	else
		echo "qq_root_ln: Already exists: $link"
	fi
}

# ##########################
# Setup
# ##########################

# Set up directories
backups_dir="/mnt/ext1/backups"
backups_home_dir="$backups_dir/home/$USER"
backups_etc_dir="$backups_dir/etc"
backups_root_dir="$backups_dir/root"
backups_var_dir="$backups_dir/var"
backups_usr_share_dir="$backups_dir/usr/share"

echo "qq: Mounting ext1"
sudo mkdir /mnt/ext1
while ! mount | grep -q /mnt/ext1; do
	lsblk
	echo -n "Name of ext1: "
	read device
	if [ -b "/dev/$device" ]; then
		sudo cryptsetup luksOpen "/dev/$device" ext1
		sudo mount /dev/mapper/ext1 /mnt/ext1
		echo "qq: Done mounting ext1"
	fi
done

echo "qq: Creating directories"
sudo mkdir /mnt/part /mnt/int /mnt/ext2 /mnt/ext3 /mnt/ext4 /mnt/iphone /mnt/usb1 /mnt/usb2 /mnt/usb3 /mnt/usb4 /mnt/cd1 /mnt/cd2 /mnt/cd3 /mnt/cd4 /mnt/cd5 /mnt/cd6
mkdir -p "$HOME"/.config "$HOME"/.local/share
sudo mkdir -p /root/.config /root/.local/share

echo "qq: Adding configs"
qq_conf_add_ow "$backups_home_dir"/.bashrc
sudo rm -rf "$HOME"/.bash_logout
sudo rm -rf /root/.bashrc
qq_root_ln "$HOME"/.bashrc
qq_conf_add_ow "$backups_home_dir"/.profile
sudo rm -rf /root/.profile
qq_root_ln "$HOME"/.profile
qq_conf_add "$backups_home_dir"/.asoundrc
qq_conf_add_ow "$backups_home_dir"/.Xresources
qq_conf_add "$backups_home_dir"/.config/mimeapps.list
qq_root_ln "$HOME"/.config/mimeapps.list
qq_conf_add "$backups_home_dir"/.local/bin
qq_conf_add "$backups_home_dir"/.local/userscripts
qq_root_ln "$backups_home_dir"/.local/userscripts
qq_conf_add "$backups_home_dir"/.dotfiles

qq_conf_add "$backups_home_dir"/.themes
qq_root_ln "$HOME"/.themes
qq_conf_add "$backups_home_dir"/.local/share/fonts
qq_root_ln "$HOME"/.local/share/fonts
qq_conf_add "$backups_home_dir"/.local/share/icons
qq_root_ln "$HOME"/.local/share/icons
qq_conf_add "$backups_home_dir"/.config/gtk-3.0
qq_root_ln "$HOME"/.config/gtk-3.0
qq_conf_add "$backups_home_dir"/.config/gtk-2.0
qq_root_ln "$HOME"/.config/gtk-2.0
qq_conf_add "$backups_home_dir"/.gtkrc-2.0
qq_root_ln "$HOME"/.gtkrc-2.0

qq_su_conf_add_ow  "$backups_etc_dir"/tlp.conf
qq_su_conf_add_ow "$backups_etc_dir"/inputrc
qq_su_conf_add_ow "$backups_etc_dir"/inittab
sudo init q
qq_su_conf_add_ow "$backups_etc_dir"/fstab
qq_su_conf_add_ow "$backups_etc_dir"/default/keyboard
qq_su_conf_add_ow "$backups_etc_dir"/default/grub
# sudo update-grub

echo "qq: Adding user to input group"
sudo usermod -aG input $USER

echo "qq: Setting up ufw"
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh

echo "qq: Disabling startup services"
sudo update-rc.d networking disable

echo "qq: Fixing broken keys"
qq_su_conf_add "$backups_etc_dir"/udev/hwdb.d/99-thinkpad-extra.hwdb
sudo udevadm hwdb --update
sudo udevadm trigger /dev/input/event4

echo "qq: Adding qqsudo to sudoers"
sudo grep -q "ALL=(ALL) NOPASSWD" /etc/sudoers || sudo echo "$USER  ALL=(ALL) NOPASSWD: /home/$USER/.local/userscripts/qqsudo" | sudo tee -a /etc/sudoers

# ##########################
# Remove programs and upgrade
# ##########################

qq_apt_rm antix-goodies-core
qq_apt_rm ceni
qq_apt_rm chroot-rescue
qq_apt_rm cli-aptix
qq_apt_rm console-grid-gui
qq_apt_rm desktop-defaults-core-antix
sudo rm -rf "$HOME"/.conky*
qq_apt_rm elinks
qq_apt_rm live-kernel-updater
qq_apt_rm mc mc-data
qq_apt_rm nano
sudo rm -rf "$HOME"/.nanorc
sudo rm -rf /root/.nanorc
qq_apt_rm pppoeconf
qq_apt_rm remaster_antix
sudo rm -rf /usr/local/share/live-files
qq_apt_rm tmux
qq_apt_rm vim-tiny

sudo apt autopurge -y
sudo apt update
sudo apt upgrade -y

# ##########################
# Install Xorg and WM
# ##########################

qq_apt_add xorg
qq_apt_add xserver-xorg-video-intel
qq_apt_add xdotool xlockmore xzoom
qq_apt_add dbus dbus-x11

qq_apt_add bspwm
qq_conf_add "$backups_home_dir"/.config/bspwm
qq_conf_add "$backups_home_dir"/.config/sxhkd
qq_apt_add polybar
qq_conf_add "$backups_home_dir"/.config/polybar

# ##########################
# Install Networking Software
# ##########################

qq_apt_add iwd
qq_su_conf_add_ow "$backups_etc_dir"/iwd/main.conf
qq_su_conf_add "$backups_var_dir"/lib/iwd

qq_apt_add openvpn
qq_su_conf_add_ow "$backups_etc_dir"/openvpn
sudo update-rc.d openvpn disable

qq_apt_add ssh
qq_conf_add_ow "$backups_home_dir"/.ssh
sudo rm -rf /root/.ssh
qq_root_ln "$HOME"/.ssh
sudo update-rc.d ssh disable

# ##########################
# Install Programs (No GUI)
# ##########################

qq_apt_add acpid
qq_su_conf_add "$backups_etc_dir"/acpi/events/lidbtn
qq_apt_add bc
qq_apt_add bleachbit
qq_conf_add "$backups_home_dir"/.config/bleachbit
qq_su_conf_add "$backups_root_dir"/.config/bleachbit
qq_apt_add build-essential
qq_apt_add calcurse
qq_apt_add cpufrequtils
qq_su_conf_add_ow "$backups_etc_dir"/init.d/cpufrequtils
qq_apt_add ddccontrol
qq_apt_add exfatprogs
qq_apt_add ffmpeg
qq_apt_add fonts-dejavu-extra
qq_apt_add gcc-doc
qq_apt_add gdb
qq_apt_add gh
qq_conf_add "$backups_home_dir"/.config/gh
qq_apt_add git
qq_conf_add "$backups_home_dir"/.gitconfig
qq_apt_add imagemagick
qq_apt_add inotify-tools
qq_apt_add jq
qq_apt_add lm-sensors
qq_apt_add luckybackup
qq_su_conf_add "$backups_root_dir"/.luckyBackup
qq_apt_add macchanger
qq_apt_add mesa-utils
qq_apt_add pandoc
qq_apt_add pm-utils
qq_apt_add scrot
qq_apt_add socat
qq_apt_add splint
qq_apt_add tldr
qq_apt_add trash-cli
qq_apt_add tree
qq_apt_add unclutter-xfixes
qq_apt_add usbmuxd ifuse
qq_su_conf_add "$backups_etc_dir"/init.d/usbmuxd
sudo update-rc.d usbmuxd defaults
qq_apt_add vifm
qq_conf_add "$backups_home_dir"/.config/vifm
qq_root_ln "$HOME"/.config/vifm
qq_apt_add vim-gtk3
qq_conf_add "$backups_home_dir"/.vim
qq_root_ln "$HOME"/.vim
qq_apt_add wodim
qq_apt_add xautolock
qq_apt_add xinput
qq_apt_add yt-dlp
qq_apt_add zip unzip rar unrar 7zip zstd

# ##########################
# Install Programs (GUI)
# ##########################

qq_apt_add alacritty
qq_conf_add "$backups_home_dir"/.config/alacritty
qq_root_ln "$HOME"/.config/alacritty
qq_apt_add audacity
qq_conf_add "$backups_home_dir"/.config/audacity
qq_conf_add "$backups_home_dir"/.local/share/audacity
qq_apt_add dillo
qq_conf_add "$backups_home_dir"/.dillo
qq_apt_add feh
qq_apt_add galculator
qq_conf_add "$backups_home_dir"/.config/galculator
qq_apt_add gimp
qq_conf_add "$backups_home_dir"/.config/GIMP
qq_apt_add guvcview
qq_apt_add libreoffice
qq_conf_add "$backups_home_dir"/.config/libreoffice

qq_apt_add extrepo
if ! dpkg-query -l | grep librewolf > /dev/null; then
	sudo extrepo enable librewolf
	sudo apt update
fi
qq_apt_add librewolf
qq_conf_add "$backups_home_dir"/.librewolf
qq_conf_add "$backups_home_dir"/.mozilla
qq_conf_add "$backups_home_dir"/.local/share/tridactyl

# monero (appimage)
qq_conf_add "$backups_home_dir"/.bitmonero

qq_apt_add mpv
qq_conf_add "$backups_home_dir"/.config/mpv
qq_root_ln "$HOME"/.config/mpv
qq_apt_add picom
qq_apt_add qbittorrent
qq_conf_add "$backups_home_dir"/.config/qBittorrent
qq_conf_add "$backups_home_dir"/.local/share/qBittorrent
qq_apt_add rofi
qq_conf_add "$backups_home_dir"/.config/rofi
qq_conf_add "$backups_home_dir"/.local/share/applications
qq_apt_add telegram-desktop
qq_conf_add "$backups_home_dir"/.local/share/TelegramDesktop
qq_apt_add zathura
qq_conf_add "$backups_home_dir"/.config/zathura

# ##########################
# Copy/Install Games
# ##########################

qq_conf_add "$backups_home_dir"/Games

# wine games
qq_apt_add wine
qq_apt_add wine32:i386
qq_apt_add libvulkan1:i386
qq_apt_add libgl1:i386
qq_apt_add libxrandr2:i386

# for goldsrc engine
qq_apt_add libcrypt1:i386

# for jedi outcast singleplayer
qq_apt_add libjpeg8

qq_apt_add dosbox

qq_apt_add mednaffe

qq_apt_add mupen64plus-qt

qq_apt_add scummvm

# ##########################
# Copy documents
# ##########################

qq_conf_add "$backups_home_dir"/Videos
qq_conf_add "$backups_home_dir"/Music
qq_conf_add "$backups_home_dir"/Pictures
qq_conf_add "$backups_home_dir"/Documents
qq_conf_add "$backups_home_dir"/Desktop
qq_conf_add "$backups_home_dir"/Downloads

# ##########################
# Extra
# ##########################

# set default terminal
sudo update-alternatives --config x-terminal-emulator

# unmount ext1
if mount | grep -q /mnt/ext1; then
	sudo umount /dev/mapper/ext1
	sudo cryptsetup luksClose /dev/mapper/ext1
	echo "qq: ext1 unmounted"
fi

echo "qq: done installing!"

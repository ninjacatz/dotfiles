#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	-screenshot|-screencrop|-mic|-screen|-screen-mic|-stop
EOF
}

create_file_path () {
	mkdir "$dir"
	base_name="$1"
	ext_name="$2"
	counter=1
	while [[ -f "$dir/$base_name.$ext_name" ]]; do
		base_name="${base_name%%[0-9]*}$counter"
		counter=$((counter + 1))
	done
	echo "$dir/$base_name.$ext_name"
}

ffmpeg_record_check () {
	if pgrep -f 'ffmpeg.*-f' > /dev/null; then
		echo "ffmpeg already recording"
		exit 1
	fi
}

dir="$HOME/Downloads/recordings"
video_command=(-f x11grab -thread_queue_size 512 -r 30 -i)
video_codecs=(-c:v libx264 -preset ultrafast -pix_fmt yuv420p)
audio_command=(-f alsa -use_wallclock_as_timestamps 1 -thread_queue_size 512 -i)
audio_codecs=(-c:a libmp3lame -b:a 128k -ar 44100)
mic_audio="hw:0,0"

case "$1" in
	-screenshot)
		file_path=$(create_file_path "screenshot" "png")
		scrot "$file_path"
		;;
	-screencrop)
		file_path=$(create_file_path "screencrop" "png")
		scrot -s "$file_path"
		;;
	-mic)
		ffmpeg_record_check
		file_path=$(create_file_path "mic" "mp3")
		ffmpeg "${audio_command[@]}" "$mic_audio" "${audio_codecs[@]}" "$file_path"
		;;
	-screen)
		ffmpeg_record_check
		file_path=$(create_file_path "screen" "mp4")
		ffmpeg "${video_command[@]}" "$DISPLAY" "${video_codecs[@]}" "$file_path"
		;;
	-screen-mic)
		ffmpeg_record_check
		file_path=$(create_file_path "screen-mic" "mp4")
		ffmpeg "${video_command[@]}" "$DISPLAY" "${audio_command[@]}" "$mic_audio" "${video_codecs[@]}" "${audio_codecs[@]}" "$file_path"
		;;
	-stop)
		pkill -f 'ffmpeg.*-f'
		;;
	*)
		usage
		exit 1
		;;
esac

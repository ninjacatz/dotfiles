#!/bin/bash

if [ "$(id -u)" -eq 0 ]; then
	echo "Run as user"
	exit 1
fi

usage () {
	cat <<EOF
Usage: ${0##*/}
Options:
	t420|g15|m15|optiplex-9020
EOF
}

case "$1" in
	t420|g15|m15|optiplex-9020)
		sudo echo ""
		;;
	*)
		usage
		exit 1
		;;
esac

# ##########################
# Functions
# ##########################
qq_done_installing () {
	echo "Done installing!"
	echo "Follow up tasks:"
	echo "1. Manually install macchanger and lm-sensors if needed"
	echo "2. Boost microphone volume in alsamixer if needed"
}

qq_apt_add () {
	for arg in "$@"; do
		if dpkg -l | grep -q "^ii  $arg "; then
			echo "qq_apt_add: $arg already installed"
		else
			echo "qq_apt_add: Installing $arg"
			sudo apt install "$arg" -y
		fi
	done
}

qq_apt_rm () {
	for arg in "$@"; do
		if dpkg -l | grep -q "^ii  $arg "; then
			echo "qq_apt_rm: Removing $arg"
			sudo apt purge "$arg" -y
		else
			echo "qq_apt_rm: $arg not installed"
		fi
	done
}

qq_conf_add() {
	for arg in "$@"; do
		arg_trim="/$(echo "$arg" | cut -d'/' -f6-)"
		if [ ! -e "$arg_trim" ]; then
			echo "qq_conf_add: Copying $arg_trim"
			cp -r "$arg" "$arg_trim"
		else
			echo "qq_conf_add: Already exists: $arg_trim"
		fi
	done
}

qq_conf_add_ow() {
	for arg in "$@"; do
		arg_trim="/$(echo "$arg" | cut -d'/' -f6-)"
		echo "qq_conf_add_ow: Copying $arg_trim"
		rm -rf "$arg_trim"
		cp -r "$arg" "$arg_trim"
	done
}

qq_su_conf_add() {
	for arg in "$@"; do
		arg_trim="/$(echo "$arg" | cut -d'/' -f6-)"
		if sudo [ ! -e "$arg_trim" ]; then
			echo "qq_su_conf_add: Copying $arg_trim"
			sudo cp -r "$arg" "$arg_trim"
		else
			echo "qq_su_conf_add: Already exists: $arg_trim"
		fi
	done
}

qq_su_conf_add_ow() {
	for arg in "$@"; do
		arg_trim="/$(echo "$arg" | cut -d'/' -f6-)"
		echo "qq_su_conf_add_ow: Copying $arg_trim"
		sudo rm -rf "$arg_trim"
		sudo cp -r "$arg" "$arg_trim"
	done
}

qq_root_ln() {
	trim="${1#/home/"$USER"/}"
	link="/root/$trim"
	if sudo [ ! -L "$link" ]; then
		echo "qq_root_ln: Linking $1"
		sudo ln -s "$1" "$link"
	else
		echo "qq_root_ln: Already exists: $link"
	fi
}

qq_mount_ext1 () {
	echo "qq: Mounting ext1"
	sudo mkdir -p /mnt/ext1
	sudo chown "$USER":"$USER" /mnt/ext1
	while ! mount | grep -q /mnt/ext1; do
		lsblk
		echo -n "Partition of ext1: "
		read -r device
		if [ -b "/dev/$device" ]; then
			sudo cryptsetup luksOpen "/dev/$device" ext1
			sudo mount /dev/mapper/ext1 /mnt/ext1
			echo "qq: Done mounting ext1"
		fi
	done
}

qq_unmount_ext1 () {
	echo "qq: Unmounting ext1"
	if mount | grep -q /mnt/ext1; then
		sudo umount /dev/mapper/ext1
		sudo cryptsetup luksClose /dev/mapper/ext1
		echo "qq: ext1 unmounted"
	fi
}

qq_mount_nfs2 () {
	echo "qq: Mounting nfs2"
	sudo mkdir -p /srv/nfs2
	sudo chmod 755 /srv/nfs2
	sudo cryptsetup luksOpen /dev/sda1 nfs2
	sudo mount /dev/mapper/nfs2 /srv/nfs2
	echo "qq: Done mounting nfs2"
}

qq_unmount_nfs2 () {
	echo "qq: Unmounting nfs2"
	if mount | grep -q /srv/nfs2; then
		sudo umount /dev/mapper/nfs2
		sudo cryptsetup luksClose /dev/mapper/nfs2
		echo "qq: nfs2 unmounted"
	fi
}

# ##########################
# Begin
# ##########################
read -r -p "Must be connected to the internet. Press enter to continue"
read -r -p "WARNING: If running script for the second time (or more), make sure backups have been completed (many files will be overwritten). Press enter to continue"

# save all output to file
errors_file="$HOME/qqinstall-output.txt"
touch "$errors_file"
echo -e "\n\n\nqqinstall: $(date +"%-I:%M%P %a %b %-d")" >> "$errors_file"
mkfifo /tmp/pipe
tee -a "$errors_file" < /tmp/pipe &
exec > /tmp/pipe 2>&1

qq_mount_ext1

# ##########################
# Remove software and upgrade
# ##########################
echo "qq: Removing software"
qq_apt_rm antix-goodies-core
qq_apt_rm antix-libs
sudo rm -rf /usr/local/share/live-files
sudo rm -rf /usr/local/share/excludes
qq_apt_rm ceni
qq_apt_rm chroot-rescue
qq_apt_rm cli-aptix
qq_apt_rm console-grid-gui
qq_apt_rm desktop-defaults-core-antix
sudo rm -rf "$HOME"/.conky*
qq_apt_rm elinks
qq_apt_rm isomount
qq_apt_rm live-kernel-updater
qq_apt_rm mc mc-data
qq_apt_rm nano
sudo rm -rf "$HOME"/.nanorc
sudo rm -rf /root/.nanorc
qq_apt_rm pppoeconf
qq_apt_rm tmux
qq_apt_rm vim-tiny

echo "qq: Full purge and upgrade"
sudo apt autopurge -y
sudo apt update
sudo apt upgrade -y

# ##########################
# Base Configs
# ##########################
# set up directories
main_pc="m15"
backups_dir="/mnt/ext1/backups/disk-$main_pc"
backups_home_dir="$backups_dir/home/$USER"
backups_etc_dir="$backups_dir/etc"
backups_root_dir="$backups_dir/root"
backups_var_dir="$backups_dir/var"

echo "qq: Creating base directories"
sudo mkdir -p /mnt/nfs1 /mnt/nfs2
sudo mkdir -p /mnt/ext1 /mnt/ext2
sudo mkdir -p /mnt/iphone
sudo mkdir -p /mnt/usb1 /mnt/usb2 /mnt/usb3 /mnt/usb4 /mnt/usb5 /mnt/usb6
sudo mkdir -p /mnt/cd1 /mnt/cd2 /mnt/cd3 /mnt/cd4 /mnt/cd5 /mnt/cd6
sudo chown "$USER":"$USER" /mnt/*

mkdir -p "$HOME"/.config "$HOME"/.local/share
sudo mkdir -p /root/.config /root/.local/share

ln -s /mnt/nfs1/calendar ~
ln -s /mnt/nfs1/dev ~
ln -s /mnt/nfs1/documents ~
ln -s /mnt/nfs1/music ~
ln -s /mnt/nfs1/notes ~
ln -s /mnt/nfs1/pictures ~
ln -s /mnt/nfs1/videos ~

echo "qq: Copying base configs"
qq_conf_add_ow "$backups_home_dir"/.bashrc
sudo rm -rf "$HOME"/.bash_logout
sudo rm -rf /root/.bashrc
qq_root_ln "$HOME"/.bashrc
qq_conf_add_ow "$backups_home_dir"/.profile
sudo rm -rf /root/.profile
qq_root_ln "$HOME"/.profile
qq_root_ln "$HOME"/.config/mimeapps.list
qq_conf_add "$backups_home_dir"/.local/bin
qq_conf_add "$backups_home_dir"/.local/userscripts
qq_root_ln "$backups_home_dir"/.local/userscripts
qq_su_conf_add_ow  "$backups_etc_dir"/tlp.conf
qq_su_conf_add_ow "$backups_etc_dir"/inputrc
qq_su_conf_add_ow "$backups_etc_dir"/resolvconf/resolv.conf.d/head
qq_su_conf_add_ow "$backups_etc_dir"/inittab
sudo init q

# ##########################
# Base Setup
# ##########################
echo "qq: Setting up grub with swap if it exists"
sudo sed -i 's/^GRUB_TIMEOUT=.*/GRUB_TIMEOUT=0/' /etc/default/grub
if grep swap /etc/fstab > /dev/null; then
	swap_uuid=$(sed -n '/swap/ s/^UUID=\([^ ]*\).*/\1/p' /etc/fstab)
	sudo sed -i "/GRUB_CMDLINE_LINUX_DEFAULT=/ { /\(resume=UUID=$swap_uuid\)/! s/\"$/ resume=UUID=$swap_uuid\"/ }" /etc/default/grub
fi
sudo update-grub

echo "qq: Setting up ufw"
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing

echo "qq: Adding qqsudo and setting admin flag to sudoers"
sudo grep -q "ALL=(ALL) NOPASSWD" /etc/sudoers || sudo echo "$USER  ALL=(ALL) NOPASSWD: /home/$USER/.local/userscripts/qqsudo" | sudo tee -a /etc/sudoers
sudo grep -q "Defaults !admin_flag" /etc/sudoers || sudo echo "Defaults !admin_flag" | sudo tee -a /etc/sudoers

# ##########################
# Install Base Software
# ##########################
echo "qq: Installing base software"
qq_apt_add acpid
qq_su_conf_add "$backups_etc_dir"/acpi/events/lidbtn
qq_apt_add bc
qq_apt_add bleachbit
qq_conf_add "$backups_home_dir"/.config/bleachbit
qq_su_conf_add "$backups_root_dir"/.config/bleachbit
qq_apt_add build-essential
qq_apt_add calcurse
qq_apt_add cpufrequtils
qq_su_conf_add_ow "$backups_etc_dir"/init.d/cpufrequtils
qq_apt_add exfatprogs
qq_apt_add jq
qq_apt_add pandoc
qq_apt_add pm-utils
qq_apt_add socat
qq_apt_add tldr
qq_apt_add trash-cli
qq_apt_add tree
qq_apt_add vifm
qq_conf_add "$backups_home_dir"/.config/vifm
qq_root_ln "$HOME"/.config/vifm
qq_apt_add vim-gtk3
qq_conf_add "$backups_home_dir"/.vim
qq_root_ln "$HOME"/.vim
mkdir -p "$HOME"/.vim/swap
qq_apt_add zip unzip rar unrar 7zip zstd

# ##########################
# Install Network Software
# ##########################
echo "qq: Installing network software"
qq_apt_add iwd
qq_su_conf_add_ow "$backups_etc_dir"/iwd/main.conf
qq_su_conf_add "$backups_var_dir"/lib/iwd
qq_apt_add openvpn
qq_su_conf_add_ow "$backups_etc_dir"/openvpn
sudo update-rc.d openvpn disable
qq_apt_add ssh
sudo rm -rf /root/.ssh
qq_apt_add sshfs
qq_apt_add nfs-common

# ##########################
# Install Programming Tools
# ##########################
echo "qq: Installing programming tools"
qq_apt_add flake8
qq_apt_add gcc-doc
qq_apt_add gdb
qq_apt_add gh
qq_conf_add "$backups_home_dir"/.config/gh
qq_apt_add git
qq_conf_add "$backups_home_dir"/.gitconfig
qq_apt_add manpages
qq_apt_add manpages-dev
qq_apt_add shellcheck

# ##########################
# HOME SERVER ONLY
# ##########################
if [ "$1" == "optiplex-9020" ]; then
	qq_mount_nfs2

	# set up home server directories
	home_server_backups_dir="/srv/nfs2/"
	home_server_backups_home_dir="$home_server_backups_dir/home/$USER"
	home_server_backups_etc_dir="$home_server_backups_dir/etc"
	home_server_backups_var_dir="$home_server_backups_dir/var"

	echo "qq: Removing home server software"
	qq_apt_rm alsa-tools alsa-utils
	rm ~/.asoundrc
	sudo apt autopurge -y

	echo "qq: Adding home server configs"
	qq_conf_add "$home_server_backups_home_dir"/*
	qq_conf_add "$home_server_backups_home_dir"/.ssh
	qq_su_conf_add_ow "$home_server_backups_etc_dir"/network/interfaces
	qq_su_conf_add_ow "$home_server_backups_etc_dir"/ssh/sshd_config
	sudo ufw allow 2269/tcp

	echo "qq: Setting up home server guest user"
	sudo mkdir -p /srv/guest/upload
	sudo useradd -s /usr/sbin/nologin guest
	echo 'guest:guest' | sudo chpasswd
	sudo chown guest:guest /srv/guest/upload

	echo "qq: Setting up home server nfs"
	qq_apt_add nfs-kernel-server
	sudo update-rc.d nfs-kernel-server disable
	qq_su_conf_add_ow "$home_server_backups_etc_dir"/exports
	sudo mkdir -p /srv/nfs1
	sudo chmod 755 /srv/nfs1
	ln -s /srv/nfs1 ~/nfs1
	ln -s /srv/nfs2 ~/nfs2

	echo "qq: Setting up home server nginx"
	qq_apt_add nginx
	qq_su_conf_add_ow "$home_server_backups_etc_dir"/nginx/nginx.conf
	qq_su_conf_add_ow "$home_server_backups_etc_dir"/nginx/sites-available/default
	qq_su_conf_add_ow "$home_server_backups_var_dir"/www/html
	sudo ufw allow 80/tcp
	mkdir -p ~/nginx
	ln -s /etc/nginx/nginx.conf ~/nginx
	ln -s /etc/nginx/sites-available/default ~/nginx
	ln -s /var/www/html ~/nginx
	ln -s /var/log/nginx ~/nginx/log

	qq_unmount_nfs2
	qq_unmount_ext1

	qq_done_installing

	# exit at end of home server install
	exit 0
fi

# ##########################
# NON HOME SERVER ONLY BEYOND THIS POINT
# ##########################

# ##########################
# Copy PC configs
# ##########################
echo "qq: Copying PC configs"
qq_conf_add "$backups_home_dir"/.local/share/themes
qq_root_ln "$HOME"/.local/share/themes
mkdir -p ~/.config/fontconfig
qq_conf_add "$backups_home_dir"/.config/fontconfig/fonts.conf
qq_conf_add "$backups_home_dir"/.local/share/fonts
qq_root_ln "$HOME"/.local/share/fonts
fc-cache -f -v
qq_conf_add "$backups_home_dir"/.local/share/icons
qq_root_ln "$HOME"/.local/share/icons
qq_conf_add "$backups_home_dir"/.config/gtk-3.0
qq_root_ln "$HOME"/.config/gtk-3.0
qq_conf_add "$backups_home_dir"/.config/gtk-2.0
qq_root_ln "$HOME"/.config/gtk-2.0
qq_conf_add "$backups_home_dir"/.gtkrc-2.0
qq_root_ln "$HOME"/.gtkrc-2.0

qq_conf_add "$backups_home_dir"/downloads
qq_conf_add_ow "$backups_home_dir"/.ssh
qq_conf_add "$backups_home_dir"/.local/share/background
qq_conf_add_ow "$backups_home_dir"/.Xresources
qq_conf_add "$backups_home_dir"/.config/mimeapps.list
qq_conf_add "$backups_home_dir"/.config/user-dirs.dirs
qq_conf_add "$backups_home_dir"/.asoundrc
qq_conf_add "$backups_home_dir"/.dotfiles
qq_conf_add "$backups_home_dir"/README.md

# ##########################
# PC Setup
# ##########################
echo "qq: Adding user to input group"
sudo usermod -aG input "$USER"

echo "qq: Disabling startup services"
sudo update-rc.d networking disable
sudo update-rc.d ssh disable

# ##########################
# Install Xorg and WM
# ##########################
echo "qq: Installing Xorg and WM"
qq_apt_add xorg
qq_apt_add xserver-xorg-video-intel
qq_apt_add xdotool xlockmore xzoom
qq_apt_add xinput
qq_apt_add dbus dbus-x11
qq_apt_add bspwm
qq_conf_add "$backups_home_dir"/.config/bspwm
qq_conf_add "$backups_home_dir"/.config/sxhkd
qq_apt_add polybar
qq_conf_add "$backups_home_dir"/.config/polybar

# ##########################
# Install PC Software
# ##########################
echo "qq: Installing PC software"
qq_apt_add alacritty
qq_conf_add "$backups_home_dir"/.config/alacritty
sudo update-alternatives --set x-terminal-emulator /usr/bin/alacritty
qq_root_ln "$HOME"/.config/alacritty
qq_apt_add audacity
qq_conf_add "$backups_home_dir"/.config/audacity
qq_conf_add "$backups_home_dir"/.local/share/audacity
qq_apt_add ddccontrol
qq_apt_add ffmpeg
qq_apt_add feh
qq_apt_add fonts-dejavu-extra
qq_apt_add galculator
qq_conf_add "$backups_home_dir"/.config/galculator
qq_apt_add gimp
qq_conf_add "$backups_home_dir"/.config/GIMP
qq_apt_add guvcview
qq_apt_add imagemagick
qq_apt_add libreoffice-writer
qq_conf_add "$backups_home_dir"/.config/libreoffice
# librewolf (extrepo)
qq_apt_add extrepo
if ! dpkg-query -l | grep librewolf > /dev/null; then
	sudo extrepo enable librewolf
	sudo apt update
fi
qq_apt_add librewolf
qq_conf_add "$backups_home_dir"/.librewolf
qq_apt_add mesa-utils
qq_conf_add "$backups_home_dir"/.mozilla
# monero (appimage)
qq_conf_add "$backups_home_dir"/.bitmonero
qq_apt_add mpv
qq_conf_add "$backups_home_dir"/.config/mpv
qq_root_ln "$HOME"/.config/mpv
qq_apt_add picom
qq_apt_add qbittorrent
qq_conf_add "$backups_home_dir"/.config/qBittorrent
qq_conf_add "$backups_home_dir"/.local/share/qBittorrent
qq_apt_add rofi
qq_conf_add "$backups_home_dir"/.config/rofi
qq_conf_add "$backups_home_dir"/.local/share/applications
qq_apt_add scrot
# soulseek (appimage)
qq_conf_add "$backups_home_dir"/.soulseek
qq_apt_add telegram-desktop
qq_conf_add "$backups_home_dir"/.local/share/TelegramDesktop
qq_apt_add unclutter-xfixes
qq_apt_add usbmuxd ifuse
qq_su_conf_add "$backups_etc_dir"/init.d/usbmuxd
sudo update-rc.d usbmuxd defaults
qq_apt_add xautolock
qq_apt_add yt-dlp
qq_apt_add zathura
qq_conf_add "$backups_home_dir"/.config/zathura

# ##########################
# Install/Copy Games
# ##########################
echo "qq: Installing game software"
qq_apt_add dosbox
qq_apt_add mednaffe
qq_apt_add mupen64plus-qt
qq_apt_add scummvm
# wine games
qq_apt_add wine
qq_apt_add wine32:i386
qq_apt_add mesa-vulkan-drivers
qq_apt_add libvulkan1:i386
qq_apt_add libgl1:i386
qq_apt_add libxrandr2:i386
# for goldsrc engine
qq_apt_add libcrypt1:i386
# for jedi outcast singleplayer
qq_apt_add libjpeg8

echo "qq: Copying game files"
qq_conf_add "$backups_home_dir"/games

# ##########################
# Installing configs for specific PCs
# ##########################
echo "qq: Running $1 config script"
~/.local/userscripts/bin/qqinstall-config "$1"

# ##########################
# Unmounting
# ##########################
qq_unmount_ext1

qq_done_installing

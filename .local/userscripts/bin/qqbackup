#!/bin/bash
set -eo pipefail
source_dir=$(cd -- "$(dirname -- "$0")" && pwd)
. "$source_dir/../qquser-check"

if [ -d ~/.wine ]; then
	read -r -p "Do you want to delete ~/.wine? (y/N) " wine_answer
fi
read -r -p "Push dotfile updates to GitHub? (y/N) " github_answer
read -r -p "Do you want to eject devices after backup? (y/N) " eject_answer

if [ "${github_answer,,}" = "y" ]; then
	echo "----------------------------------------------"
	echo "PUSHING DOTFILES TO GITHUB"
	echo "----------------------------------------------"
	"$source_dir/qqdotfiles" commit
	"$source_dir/qqdotfiles" push
fi

"$source_dir/qqmount" ext1
"$source_dir/qqmount" ext2
"$source_dir/qqnfs" -mount hs

echo "----------------------------------------------"
echo "SYNCING DOTFILES TO HOME SERVER"
echo "----------------------------------------------"
home_server_dotfiles=(
	"$HOME/.bashrc"
	"$HOME/.profile"
	"$HOME/.vim/autoload"
	"$HOME/.vim/colors"
	"$HOME/.vim/plugged"
	"$HOME/.vim/vimrc"
	"$HOME/.vim/claude-api.key"
	"$HOME/.config/vifm/colors"
	"$HOME/.config/vifm/scripts"
	"$HOME/.config/vifm/vifmrc"
	"$HOME/.config/mimeapps.list"
	"$HOME/.local/userscripts"
	"$HOME/.local/bin"
)
for file in "${home_server_dotfiles[@]}"; do
	rsync -av "$file" hs:"$(dirname "$file")"
done
echo "----------------------------------------------"
echo "SYNCING DOTFILES TO OTHER PC"
echo "----------------------------------------------"
if [ "$1" == "-other-pc" ]; then
	other_pc="qq@192.168.1.7"
	other_pc_dotfiles=(
		"$HOME/.asoundrc"
		"$HOME/.gtkrc-2.0"
		"$HOME/.config/alacritty"
		"$HOME/.config/bspwm"
		"$HOME/.config/gtk-2.0"
		"$HOME/.config/gtk-3.0"
		"$HOME/.config/mpv"
		"$HOME/.config/polybar"
		"$HOME/.config/sxhkd"
		"$HOME/.config/zathura"
		"$HOME/.local/asus-config"
	)
	for file in "${home_server_dotfiles[@]}"; do
		rsync -av "$file" "$other_pc":"$(dirname "$file")"
	done
	for file in "${other_pc_dotfiles[@]}"; do
		rsync -av "$file" "$other_pc":"$(dirname "$file")"
	done
else
	echo "Skipping..."
fi
echo "----------------------------------------------"
echo "CLEANING PC AND HOME SERVER"
echo "----------------------------------------------"
if [ "${wine_answer,,}" = "y" ]; then
	"$source_dir/qqclean" -delete-wine
else
	"$source_dir/qqclean"
fi
ssh hs "$HOME/.local/userscripts/bin/qqclean"
echo "----------------------------------------------"
echo "BACKING UP /mnt/nfs"
echo "----------------------------------------------"
rsync -av --delete /mnt/nfs/ /mnt/ext1/backups/nfs/
echo "----------------------------------------------"
echo "BACKING UP HOME SERVER $HOME"
echo "----------------------------------------------"
rsync -av --delete hs:/home/"$USER"/ /mnt/ext1/backups/disk-home-server/"$HOME"/
echo "----------------------------------------------"
echo "BACKING UP HOME SERVER /etc"
echo "----------------------------------------------"
rsync -av --delete --rsync-path="sudo ~/.local/userscripts/qqsudo rsync" hs:/etc/ /mnt/ext1/backups/disk-home-server/etc/
echo "----------------------------------------------"
echo "BACKING UP HOME SERVER /var"
echo "----------------------------------------------"
rsync -av --delete --rsync-path="sudo ~/.local/userscripts/qqsudo rsync" hs:/var/ /mnt/ext1/backups/disk-home-server/var/
echo "----------------------------------------------"
echo "BACKING UP $HOME (EXCLUDING Downloads/nobackup)"
echo "----------------------------------------------"
rsync -av --delete --delete-excluded --exclude='Downloads/nobackup/' "$HOME"/ /mnt/ext1/backups/disk/"$HOME"/
echo "----------------------------------------------"
echo "BACKING UP /etc"
echo "----------------------------------------------"
sudo "$source_dir/../qqsudo" rsync -av --delete /etc/ /mnt/ext1/backups/disk/etc/
echo "----------------------------------------------"
echo "BACKING UP /var"
echo "----------------------------------------------"
sudo "$source_dir/../qqsudo" rsync -av --delete /var/ /mnt/ext1/backups/disk/var/
echo "----------------------------------------------"
echo "BACKING UP /root"
echo "----------------------------------------------"
sudo "$source_dir/../qqsudo" rsync -av --delete /root/ /mnt/ext1/backups/disk/root/
echo "----------------------------------------------"
echo "BACKING UP /usr/share"
echo "----------------------------------------------"
sudo "$source_dir/../qqsudo" rsync -av --delete /usr/share/ /mnt/ext1/backups/disk/usr/share/
echo "----------------------------------------------"
echo "BACKING UP /mnt/ext1 TO /mnt/ext2 (EXCLUDING backups)"
echo "----------------------------------------------"
rsync -av --delete --delete-excluded --exclude='backups/' /mnt/ext1/ /mnt/ext2/

if [ "${eject_answer,,}" = "y" ]; then
	"$source_dir/qqmount" -u ext1
	"$source_dir/qqmount" -u ext2
	"$source_dir/qqnfs" -umount hs
fi

read -r -p "Done backing up. Press enter to continue..."
